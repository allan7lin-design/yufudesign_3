<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµåˆ†æµç³»çµ± V24.36 (å«å‚™ä»½é‚„åŸé¢æ¿)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>    
<style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --white: #ffffff; --border: #cbd5e1; }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1f2937; height: 100vh; display: flex; flex-direction: column; font-size: 14px; }
        
        /* Navigation */
        nav { background: #1e40af; padding: 10px 20px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-x: auto; }
        nav button { background: rgba(255,255,255,0.15); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: bold; transition: 0.2s; font-size: 14px; }
        nav button:hover { background: rgba(255,255,255,0.3); }
        nav button.active { background: white; color: #1e40af; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Backup Button Specific Style */
        .btn-backup-nav { background: #059669 !important; } 
        .btn-backup-nav:hover { background: #10b981 !important; }

        .status-badge { margin-left: auto; color: white; font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; background: rgba(0,0,0,0.25); border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .dot.ok { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .dot.loading { background: #f59e0b; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Main Layout */
        main { flex: 1; padding: 20px; overflow-y: auto; }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard & General */
        .dashboard-panel { 
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); 
            border: 1px solid #3b82f6; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.1);
            display: flex; align-items: center; justify-content: space-between; gap: 15px;
        }
        .dash-stats { display: flex; gap: 15px; }
        .stat-card { background: white; padding: 8px 15px; border-radius: 6px; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-num { font-size: 20px; font-weight: 900; }
        .stat-label { font-size: 13px; color: #555; font-weight: bold; }
        .sc-blue { color: #1e40af; border-bottom: 3px solid #1e40af; }
        .sc-orange { color: #c2410c; border-bottom: 3px solid #f97316; }
        .sc-purple { color: #6b21a8; border-bottom: 3px solid #a855f7; }

        /* Alert Banner */
        .alert-banner {
            display: none; /* Default Hidden */
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.15);
            animation: slideDown 0.3s ease-out;
            align-items: center;
            justify-content: space-between;
        }
        .alert-banner.flex { display: flex; }
        .alert-content { display: flex; align-items: center; gap: 10px; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Report List Styles */
        .report-list-item {
            padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px;
        }
        .report-list-item:last-child { border-bottom: none; }
        .tag-mode { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; }
        .tm-self { background: #2563eb; }
        .tm-freight { background: #d97706; }
        .tm-install { background: #7e22ce; }

        /* Upcoming Schedule Panel */
        .upcoming-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .up-col { 
            background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); 
            max-height: 250px; overflow-y: auto; 
        }
        .up-col h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #374151; position: sticky; top: 0; background: white; z-index: 10; }
        .up-item { display: flex; align-items: center; gap: 10px; font-size: 12px; padding: 6px 0; border-bottom: 1px dashed #f3f4f6; position: relative; cursor: help; overflow: visible !important; }
        .up-item:last-child { border-bottom: none; }
        .up-date { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-weight: bold; white-space: nowrap; }
        .up-info { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; color: #4b5563; flex: 1; }

        .up-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: #fff; padding: 10px 12px; border-radius: 6px; font-size: 12px; width: 240px; white-space: normal; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: left; line-height: 1.5; pointer-events: none; }
        .up-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .up-item:hover .up-tooltip { display: block; }
        .up-tooltip-title { font-weight: bold; color: #93c5fd; margin-bottom: 5px; display: block; border-bottom: 1px solid #374151; padding-bottom: 3px; }
        .up-tooltip-row { display: flex; justify-content: space-between; margin-bottom: 2px; }

        /* Dispatcher Grid */
        .dispatcher-grid { display: grid; grid-template-columns: 480px 1fr; gap: 20px; height: calc(100vh - 280px); }
        .pool-col { background: var(--white); border-radius: 8px; padding: 15px; overflow-y: auto; border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .target-col { display: grid; grid-template-rows: 1fr 1fr 1fr; gap: 15px; }

        /* Search & Filters */
        .search-box { background: #f0f9ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #bae6fd; }
        .search-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .search-row input[type="date"] { width: 110px; padding: 5px; font-size: 13px; border-radius: 4px; border: 1px solid #cbd5e1; }
        .search-row input[type="text"] { flex: 1; padding: 6px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 4px; }
        label { font-size: 13px; color: #334155; font-weight: bold; margin-bottom: 3px; display: block; }

        /* Order Cards */
        .order-group { border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px; overflow: hidden; position: relative; transition: 0.2s; }
        .order-group.manual { border-color: #f59e0b; border-width: 2px; }
        .order-group.is-hidden-order { border: 2px dashed #94a3b8; opacity: 0.8; background: #f1f5f9; }
        .order-header { background: #e2e8f0; padding: 8px 10px; font-size: 13px; font-weight: bold; display: flex; flex-direction: column; gap:3px; cursor: pointer; color: #1e293b; }
        .order-header:hover { background: #cbd5e1; }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .header-info { font-size: 12px; color: #555; font-weight: normal; background: rgba(255,255,255,0.5); padding: 4px; border-radius: 4px; display:flex; gap:10px; flex-wrap:wrap; }
        .order-actions { display:flex; gap:3px; }
        .act-btn { padding:2px 6px; font-size:11px; cursor:pointer; border-radius:4px; border:1px solid #94a3b8; background:white; }
        .act-del { color:#dc2626; border-color:#fca5a5; }

        .order-items { padding: 5px; background: #f8fafc; }
        .item-card { background: white; border: 1px solid #cbd5e1; padding: 6px 8px; border-radius: 4px; margin-bottom: 4px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px; transition: 0.1s; }
        .item-card:hover { border-color: var(--primary); background: #eff6ff; }
        .item-card.selected { border: 1px solid var(--primary); background: #dbeafe; }
        .item-card.disabled { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; opacity: 0.8; cursor: default; }
        
        .checkbox-mock { width: 16px; height: 16px; border: 1px solid #94a3b8; border-radius: 3px; display: inline-block; position: relative; flex-shrink: 0; background: white; }
        .item-card.selected .checkbox-mock { background: var(--primary); border-color: var(--primary); }
        .item-card.selected .checkbox-mock::after { content: 'âœ”'; color: white; font-size: 12px; position: absolute; top: -1px; left: 2px; font-weight: bold; }

        .item-controls { margin-left:auto; display:flex; gap:5px; }
        .btn-icon-sm { border:none; background:transparent; cursor:pointer; font-size:14px; padding:2px; opacity:0.6; transition:0.2s; }
        .btn-icon-sm:hover { opacity:1; transform:scale(1.1); }
        .btn-icon-del:hover { color:red; }
        .btn-icon-edit:hover { color:#2563eb; }

        /* Drop Zones */
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.7); transition: 0.2s; position: relative; cursor: pointer; }
        .drop-zone:hover { transform: scale(1.01); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: var(--primary); }
        .zone-self { background: #eff6ff; } .zone-self h3 { color: #1d4ed8; }
        .zone-freight { background: #fff7ed; } .zone-freight h3 { color: #c2410c; }
        .zone-install { background: #faf5ff; } .zone-install h3 { color: #7e22ce; }
        .zone-btn { position: absolute; bottom: 10px; right: 10px; padding: 5px 12px; font-size: 12px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; }

        /* Modal & Forms */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 1px solid #e2e8f0; position: relative; }
        .modal-full { max-width: 95%; height: 95vh; display: flex; flex-direction: column; padding: 0; }
        .modal-large { max-width: 850px; width: 95%; } 
        
        .modal-header-bar { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 8px 8px 0 0; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; background: #f8fafc; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition:0.2s; font-size: 14px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-cancel { background: #e5e7eb; color: #374151; margin-right: 10px; }
        .btn-revert { background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 10px; font-weight: bold; }
        .btn-map { background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-map:hover { background: #2563eb; transform: translateY(-1px); }

        /* Batch Input Table */
        .batch-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .batch-table th { background: #f1f5f9; padding: 8px; text-align: left; border: 1px solid #e2e8f0; color: #475569; }
        .batch-table td { padding: 5px; border: 1px solid #e2e8f0; }
        .batch-table input { border: 1px solid #cbd5e1; padding: 6px; width: 100%; border-radius: 4px; }
        .batch-table input:focus { border-color: var(--primary); outline: none; }
        .btn-add-row { width: 100%; background: #ecfdf5; color: #047857; border: 1px dashed #10b981; padding: 8px; margin-top: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .btn-add-row:hover { background: #d1fae5; }
        .row-del-btn { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Factory Card & Tooltip Styles */
        .factory-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s; position: relative; }
        .factory-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .factory-header { padding: 10px; font-weight: bold; display: flex; justify-content: space-between; border-radius: 8px 8px 0 0; }
        .factory-body { padding: 10px; }
        .factory-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: #fff; padding: 10px; border-radius: 6px; font-size: 12px; width: 260px; max-height: 300px; overflow-y: auto; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left; pointer-events: none; }
        .factory-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .factory-card:hover .factory-tooltip { display: block; }

        /* Route Styles */
        .route-text-flow { background: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 13px; line-height: 1.6; }
        .route-arrow { color: #94a3b8; margin: 0 5px; font-weight: bold; }
        
        /* Factory Detail Styles */
        .fd-cust-header { background: #e0f2fe; color: #0369a1; padding: 8px 10px; border-radius: 6px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; border: 1px solid #bae6fd; display: flex; align-items: center; gap: 5px; }
        .fd-cust-header:first-child { margin-top: 0; }
        .fd-spacer { flex: 1; }
        .btn-xs-batch { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: 1px solid; cursor: pointer; background: white; margin-left: 5px; }
        .btn-xs-batch.batch-ret { border-color: #fca5a5; color: #dc2626; }
        .btn-xs-batch.batch-ret:hover { background: #fef2f2; }
        .btn-xs-batch.batch-mov { border-color: #fbbf24; color: #d97706; }
        .btn-xs-batch.batch-mov:hover { background: #fffbeb; }

        .fd-item-card { border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; padding: 10px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-left: 5px; border-left: 3px solid #cbd5e1; }
        .fd-item-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #1e293b; }
        .fd-spec { color: #64748b; font-size: 13px; margin-bottom: 5px; }
        .fd-actions { display: flex; gap: 10px; margin-top: 10px; }
        .fd-btn { flex: 1; padding: 10px; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .fd-btn.picked { border-color: #86efac; color: #166534; background: #f0fdf4; }
        .fd-btn.picked:hover, .fd-btn.picked.active { background: #166534; color: white; }
        .fd-btn.issue { border-color: #fca5a5; color: #991b1b; background: #fef2f2; }
        .fd-btn.issue:hover { background: #991b1b; color: white; }

        .task-card-done { opacity: 0.6; filter: grayscale(1); background: #f3f4f6 !important; }
        .task-cust-title { font-weight: bold; font-size: 16px; color: #1e3a8a; margin-bottom: 8px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }

        .exception-popup { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; border-top: 2px solid #333; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 2000; transform: translateY(100%); transition: 0.3s; }
        .exception-popup.show { transform: translateY(0); }

        /* Image Preview Styles */
        .img-icon { cursor: pointer; color: #2563eb; font-size: 16px; vertical-align: middle; margin-left: 5px; }
        .img-preview-box { max-width: 100%; max-height: 200px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .img-preview-box.show { display: block; }
        .paste-zone { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; color: #64748b; margin-top: 10px; border-radius: 6px; cursor: pointer; }
        .paste-zone:hover { background: #f8fafc; border-color: var(--primary); }

        /* --- WORK ORDER (PRINT) STYLES --- */
        .work-order-paper {
            width: 210mm; /* A4 Width */
            min-height: 297mm;
            padding: 10mm;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            color: black;
            font-family: "Microsoft JhengHei", serif;
            box-sizing: border-box;
        }
        .wo-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px; }
        .wo-header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; border: 1px solid #000; padding: 10px; }
        .wo-row { display: flex; margin-bottom: 5px; font-size: 15px; }
        .wo-label { font-weight: bold; width: 80px; }
        .wo-value { flex: 1; border-bottom: 1px dashed #999; }
        
        .wo-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .wo-table th, .wo-table td { border: 1px solid black; padding: 8px; text-align: left; vertical-align: top; }
        .wo-table th { background: #f0f0f0; text-align: center; font-weight: bold; }
        
        .wo-img-cell img { max-width: 150px; max-height: 150px; display: block; margin-top: 5px; }
        .btn-upload-small { background: #e0f2fe; border: 1px dashed #0284c7; color: #0284c7; padding: 4px; font-size: 11px; cursor: pointer; text-align: center; display: inline-block; margin-top: 5px; width: 100px; }

        @media print {
            body * { visibility: hidden; }
            #workOrderModal, #workOrderModal * { visibility: visible; }
            #workOrderModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 0; display: block !important; }
            .modal-content { box-shadow: none; border: none; width: 100%; max-width: 100%; height: auto; padding: 0; margin: 0; overflow: visible; }
            .work-order-paper { box-shadow: none; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
        }
/* === è·¯å¾‘è¦åŠƒèˆ‡æ‰‹å‹•æ’åºæ¨£å¼ === */
        .route-container {
            position: relative;
            padding-left: 20px; /* ç•™çµ¦æ™‚é–“è»¸ç·š */
            margin-top: 15px;
        }
        /* å‚ç›´é€£æ¥ç·š */
        .route-container::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 10px;
            bottom: 10px;
            width: 2px;
            background: #cbd5e1;
            z-index: 0;
        }
        
        .route-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab; /* æ‰‹å½¢æ¸¸æ¨™ */
        }
        .route-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-color: #94a3b8;
        }
        .route-card.dragging {
            opacity: 0.5;
            background: #f1f5f9;
            border: 2px dashed #3b82f6;
        }

        /* åºè™Ÿåœ“åœˆåœ–ç¤º */
        .route-icon-box {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .route-card:first-child .route-icon-box { background: #10b981; } /* èµ·é»ç¶ è‰² */
        .route-card:last-child .route-icon-box { background: #ef4444; } /* çµ‚é»ç´…è‰² */

        .route-info { flex: 1; }
        .route-addr { font-weight: bold; font-size: 14px; color: #1e293b; }
        .route-desc { font-size: 12px; color: #64748b; display:flex; gap:10px; }

        /* æ“ä½œæŒ‰éˆ•å€ */
        .route-actions {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .btn-move {
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            color: #64748b;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .btn-move:hover { background: #e2e8f0; color: #0f172a; }

        /* æ‹–æ›³æ™‚çš„ placeholder */
        .sortable-placeholder {
            border: 2px dashed #cbd5e1;
            background: #f8fafc;
            height: 60px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
/* === åœ°åœ–èˆ‡æ’ç¨‹åˆ†å‰²è¦–çª—æ¨£å¼ === */
        .split-container { display: flex; gap: 20px; height: calc(100vh - 200px); }
        
        /* å·¦å´åˆ—è¡¨å€ */
        .list-panel { flex: 1; overflow-y: auto; padding-right: 5px; min-width: 320px; }
        
        /* å³å´åœ°åœ–å€ */
        .map-panel { flex: 2; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; position: relative; }
        #map-driver, #map-install { width: 100%; height: 100%; z-index: 1; }

        /* åœ°åœ–ä¸Šçš„åºè™Ÿæ¨™è¨˜ */
/* åœ°åœ–ä¸Šçš„åºè™Ÿæ¨™è¨˜ (ä¿®æ­£ç‰ˆ) */
        .map-marker-icon {
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            /* æ”¹ç”¨ Flexbox ç¢ºä¿æ•¸å­—çµ•å°ç½®ä¸­ */
            display: flex;
            align-items: center;
            justify-content: center;
            
            font-weight: bold;
            font-size: 14px;
            width: 30px !important;
            height: 30px !important;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        /* æ»‘é¼ ç§»éå»ç¨å¾®æ”¾å¤§ */
        .map-marker-icon:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        .marker-start { background-color: #10b981 !important; } /* èµ·é»ç¶ è‰² */
        .marker-end { background-color: #ef4444 !important; }   /* çµ‚é»ç´…è‰² */
        /* è®€å–é®ç½© */
        .map-loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

<nav>
    <button class="active" onclick="switchView('dispatcher')">ğŸ‘¨â€ğŸ’» KEYå–®è€…</button>
    <button onclick="switchView('driver')">ğŸšš é€è²¨å“¡ (è·¯å¾‘)</button>
    <button onclick="switchView('freight')">ğŸ“¦ è²¨é‹</button>
    <button onclick="switchView('installer')">ğŸ”§ æ–½å·¥ (å«å°èˆª)</button>
    <button class="btn-backup-nav" onclick="openDataModal()">ğŸ’¾ è³‡æ–™å‚™ä»½/é‚„åŸ</button>
    
    <div class="status-badge" onclick="openConfig()">
        <div id="cloudDot" class="dot"></div>
        <span id="cloudText">æœªé€£ç·š</span>
        <span>âš™ï¸</span>
    </div>
</nav>

<main>
    <div id="view-dispatcher" class="view-section active">
        <div id="overdueAlert" class="alert-banner">
            <div class="alert-content">
                <span>ğŸš¨</span> 
                <div>è­¦å‘Šï¼šåµæ¸¬åˆ° <b id="overdueCount" style="font-size:18px; text-decoration:underline;">0</b> ç­†ã€Œä»Šæ—¥æˆ–éæœŸã€çš„ä»»å‹™å°šæœªå®Œæˆï¼</div>
            </div>
            <button class="btn btn-sm" style="background:#dc2626; color:white; border:none;" onclick="openReportModal()">æŸ¥çœ‹æ¸…å–®</button>
        </div>

        <div class="dashboard-panel">
            <div class="dash-title">
                â˜€ï¸ ä»Šæ—¥å·¥ä½œ <span id="dashDate" style="font-size:14px; color:#666; font-weight:normal;"></span>
                <button class="btn btn-sm" style="margin-left:10px; background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd;" onclick="openReportModal()">ğŸ“Š ä»Šæ—¥/é€¾æœŸå ±è¡¨</button>
            </div>
            <div class="dash-stats">
                <div class="stat-card sc-blue"><span class="stat-label">ğŸšš è‡ªé€</span><span class="stat-num" id="count-self">0</span></div>
                <div class="stat-card sc-orange"><span class="stat-label">ğŸ“¦ è²¨é‹</span><span class="stat-num" id="count-freight">0</span></div>
                <div class="stat-card sc-purple"><span class="stat-label">ğŸ”§ æ–½å·¥</span><span class="stat-num" id="count-install">0</span></div>
            </div>
        </div>
        
        <h4 style="margin: 0 0 10px 0; color: #4b5563;">ğŸ“… æœªä¾†æ’ç¨‹é è¦½ (æ²å‹•æŸ¥çœ‹æ›´å¤š)</h4>
        <div class="upcoming-panel">
            <div class="up-col">
                <h4 style="border-bottom-color: #93c5fd; color:#1e40af;">ğŸšš å³å°‡é€è²¨</h4>
                <div id="up-self"><div style="color:#999; font-size:12px;">ç„¡æ’ç¨‹</div></div>
            </div>
            <div class="up-col">
                <h4 style="border-bottom-color: #fdba74; color:#c2410c;">ğŸ“¦ å³å°‡è²¨é‹</h4>
                <div id="up-freight"><div style="color:#999; font-size:12px;">ç„¡æ’ç¨‹</div></div>
            </div>
            <div class="up-col">
                <h4 style="border-bottom-color: #d8b4fe; color:#6b21a8;">ğŸ”§ å³å°‡æ–½å·¥</h4>
                <div id="up-install"><div style="color:#999; font-size:12px;">ç„¡æ’ç¨‹</div></div>
            </div>
        </div>

        <div class="dispatcher-grid">
            <div class="pool-col">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; font-size:18px;">ğŸ“¦ è¨‚å–®æ± </h3>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-warning" style="padding:6px 12px; font-size:12px;" onclick="createManualOrder()">+ è‡¨æ™‚å–®</button>
                        <button class="btn btn-primary" style="padding:6px 12px; font-size:12px;" onclick="syncCloud()">ğŸ”„ åŒæ­¥</button>
                    </div>
                </div>
                
                <div class="search-box">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <label style="margin:0;">ğŸ” ç¯©é¸èˆ‡ç‹€æ…‹</label>
                        <div style="font-size:12px;"><input type="checkbox" id="showHidden" onchange="renderPool()"> é¡¯ç¤ºå·²éš±è—</div>
                    </div>
                    <div class="search-row">
                        <input type="date" id="filterStart" onchange="renderPool()">
                        <span style="font-weight:bold; color:#666;">~</span>
                        <input type="date" id="filterEnd" onchange="renderPool()">
                        <button class="btn" style="background:#64748b; color:white; padding:5px 10px; font-size:12px;" onclick="clearFilters()">æ¸…é™¤</button>
                    </div>
                    <div class="search-row">
                        <input type="text" id="filterKeyword" placeholder="æœå°‹ å®¢æˆ¶åç¨± / å–®è™Ÿ ..." oninput="renderPool()">
                    </div>
                </div>

                <div id="itemsPool"></div>
                <div class="pool-footer">
                    <div id="poolStats" style="font-size:12px; color:#666; text-align:center;"></div>
                </div>
            </div>

            <div class="target-col">
                <div class="drop-zone zone-self" onclick="openDispatchModal('self')">
                    <h3>ğŸšš è‡ªé€ (å…¬å¸è»Š)</h3>
                    <p>æŒ‡æ´¾å·¥å» å–è²¨ â” é€å›å…¬å¸ æˆ– å®¢æˆ¶</p>
                    <button class="zone-btn">ç§»å…¥æ’ç¨‹</button>
                </div>
                <div class="drop-zone zone-freight" onclick="openDispatchModal('freight')">
                    <h3>ğŸ“¦ è²¨é‹ / å¿«é</h3>
                    <p>æŒ‡æ´¾å·¥å» å–è²¨ â” å¡«å¯«è²¨é‹å–®</p>
                    <button class="zone-btn">ç§»å…¥æ’ç¨‹</button>
                </div>
                <div class="drop-zone zone-install" onclick="openDispatchModal('install')">
                    <h3>ğŸ”§ æ–½å·¥ / å®‰è£</h3>
                    <p>æŒ‡æ´¾å·¥ç­ â” å–è²¨ â” æ–½å·¥</p>
                    <button class="zone-btn">ç§»å…¥æ’ç¨‹</button>
                </div>
            </div>
        </div>
    </div>

<div id="view-driver" class="view-section">
        <div class="date-bar">
            <label>ğŸ“… é€è²¨æ—¥æœŸï¼š</label>
            <input type="date" id="driverDate" onchange="renderDriverView()">
        </div>
        
        <h3 style="margin:0 0 10px 0; color:#1e3a8a;">ğŸ­ ç¬¬ä¸€æ­¥ï¼šå·¥å» å–è²¨ç¸½è¡¨</h3>
        <div id="driverPickupContent" class="pickup-container"></div>
        <div class="section-divider"><span class="section-label">â¬‡ï¸ å–è²¨å¾Œé…é€ (æ‹–æ›³åˆ—è¡¨èª¿æ•´é †åºï¼Œå³å´åœ°åœ–å³æ™‚æ›´æ–°) â¬‡ï¸</span></div>
        
        <div class="split-container">
            <div class="list-panel">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="routeStart" list="addressHistory" placeholder="å‡ºç™¼åœ° (ç¸½å…¬å¸)" value="ç¸½å…¬å¸" style="flex:1;">
                    <button class="btn-map" onclick="openGoogleMapsRoute('driver')">ğŸ—ºï¸ å°èˆª</button>
                </div>
                <div id="driverRouteTimeline" class="route-timeline"></div>
            </div>
            <div class="map-panel">
                <div id="map-driver"></div>
                <div id="loading-driver" class="map-loading">
                    <div class="loading-spinner"></div>
                    <span style="margin-top:10px; font-weight:bold; color:#555;">æ­£åœ¨å®šä½åœ°å€...</span>
                </div>
            </div>
        </div>
        <h3 style="margin:10px 0 10px 0; color:#1e3a8a;">ğŸ“¦ ç¬¬ä¸‰æ­¥ï¼šé€è²¨å–®</h3>
        <div id="driverContent"></div>
    </div>

    <div id="view-freight" class="view-section">
        <div class="date-bar"><label>ğŸ“… å«ä»¶æ—¥æœŸï¼š</label><input type="date" id="freightDate" onchange="renderFreightView()"></div>
        <h3 style="margin:0 0 10px 0; color:#c2410c;">ğŸ­ å–è²¨/å«ä»¶ç¸½è¡¨</h3>
        <div id="freightPickupContent" class="pickup-container"></div>
        <div class="section-divider"><span class="section-label">è©³ç´°æ¸…å–®</span></div>
        <div id="freightContent"></div>
    </div>

    <div id="view-installer" class="view-section">
        <div class="date-bar"><label>ğŸ“… æ–½å·¥æ—¥æœŸï¼š</label><input type="date" id="installDate" onchange="renderInstallView()"></div>
        
        <h3 style="margin:0 0 10px 0; color:#6b21a8;">ğŸ­ ç¬¬ä¸€æ­¥ï¼šé ˜æ–™/å–è²¨ç¸½è¡¨</h3>
        <div id="installPickupContent" class="pickup-container"></div>
        
        <div class="section-divider"><span class="section-label">â¬‡ï¸ æ–½å·¥è·¯å¾‘è¦åŠƒ (æ‹–æ›³åˆ—è¡¨èª¿æ•´é †åºï¼Œå³å´åœ°åœ–å³æ™‚æ›´æ–°) â¬‡ï¸</span></div>

        <div class="split-container">
            <div class="list-panel">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="installRouteStart" list="addressHistory" placeholder="å‡ºç™¼åœ° (ç¸½å…¬å¸)" value="ç¸½å…¬å¸" style="flex:1;">
                    <button class="btn-map" onclick="openGoogleMapsRoute('installer')">ğŸ—ºï¸ å°èˆª</button>
                </div>
                <div id="installRouteTimeline" class="route-timeline"></div>
            </div>
            <div class="map-panel">
                <div id="map-install"></div>
                <div id="loading-install" class="map-loading">
                    <div class="loading-spinner"></div>
                    <span style="margin-top:10px; font-weight:bold; color:#555;">æ­£åœ¨å®šä½åœ°å€...</span>
                </div>
            </div>
        </div>
        <h3 style="margin:10px 0 10px 0; color:#6b21a8;">ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šæ–½å·¥ä»»å‹™æ¸…å–®</h3>
        <div id="installContent"></div>
    </div>
</main>

<div id="reportModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header-bar">
            <h3>ğŸ“Š ä»Šæ—¥èˆ‡é€¾æœŸå·¥å–®æ¦‚æ³</h3>
            <button class="btn btn-cancel" onclick="document.getElementById('reportModal').style.display='none'">X</button>
        </div>
        <div class="modal-body" style="display:flex; gap:20px; flex-wrap: wrap;">
            <div style="flex:1; min-width:300px; border-right:1px solid #eee; padding-right:10px;">
                <h4 style="color:#dc2626; border-bottom:2px solid #fca5a5; padding-bottom:5px;">âš ï¸ æœªå®Œæˆ (ä»Šæ—¥+é€¾æœŸ)</h4>
                <div id="listUnfinished" style="max-height:400px; overflow-y:auto;"></div>
            </div>
            <div style="flex:1; min-width:300px; padding-left:10px;">
                <h4 style="color:#16a34a; border-bottom:2px solid #86efac; padding-bottom:5px;">âœ… ä»Šå¤©å·²å®Œæˆ</h4>
                <div id="listCompleted" style="max-height:400px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</div>

<div id="dispatchModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="font-size:18px; margin-top:0;">åˆ†æ´¾è¨­å®š</h3>
        <div id="selectedItemsSummary" style="background:#eff6ff; padding:10px; border-radius:6px; font-size:14px; margin-bottom:15px; color:#1e3a8a; border: 1px solid #bfdbfe;"></div>
        <form onsubmit="event.preventDefault(); submitDispatch();">
            <div class="form-group"><label>ğŸ“… åŸ·è¡Œæ—¥æœŸ</label><input type="date" id="modalDate" required></div>
            <div class="form-group"><label>ğŸ­ å‡ºè²¨å·¥å» </label><input type="text" id="modalFactory" list="vendorList" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." required></div>
            
            <div id="field-installer" class="conditional-field" style="display:none;">
                <div class="form-group"><label>ğŸ‘· æ–½å·¥äººå“¡</label><input type="text" id="modalWorker" list="vendorList" placeholder="è¼¸å…¥æˆ–é¸æ“‡..."></div>
            </div>
            
            <div id="field-address" class="conditional-field">
                <div class="form-group">
                    <label id="lbl-address">ğŸ“ åœ°å€ (è‡ªå‹•è¨˜æ†¶)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="modalAddress" list="addressHistory" placeholder="è¼¸å…¥åœ°å€..." required autocomplete="off">
                        <button type="button" class="btn" style="background:#e2e8f0; font-size:12px; padding:8px 12px;" onclick="document.getElementById('modalAddress').value='ç¸½å…¬å¸'">å›å…¬å¸</button>
                    </div>
                </div>
            </div>

            <div id="field-contact" class="conditional-field">
                <div class="form-group"><label>ğŸ‘¤ ç¾å ´è¯çµ¡ (é¸å¡«)</label><input type="text" id="modalContact"></div>
                <div class="form-group"><label>ğŸ“ é›»è©± (é¸å¡«)</label><input type="text" id="modalPhone"></div>
                <div class="form-group"><label>â° æ™‚é–“ (é¸å¡«)</label><input type="time" id="modalTime"></div>
            </div>

            <div class="form-group"><label>ğŸ“ ä»»å‹™å‚™è¨»</label><input type="text" id="modalNote"></div>
            <div style="text-align:right; margin-top:20px;">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¢ºèªåˆ†æ´¾</button>
            </div>
        </form>
    </div>
</div>

<div id="editItemModal" class="modal">
    <div class="modal-content">
        <h3>âœï¸ ç·¨è¼¯è¨‚å–®æ˜ç´°</h3>
        <input type="hidden" id="edit_oid">
        <input type="hidden" id="edit_idx">
        <div class="form-group">
            <label>å“å</label>
            <input type="text" id="edit_name" list="sharedProductList">
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div style="flex:1"><label>é•·</label><input type="text" id="edit_len"></div>
            <div style="flex:1"><label>å¯¬</label><input type="text" id="edit_wid"></div>
        </div>
        <div class="form-group">
            <label>æ•¸é‡</label>
            <input type="number" id="edit_qty">
        </div>
        <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="edit_note">
        </div>
        
        <div class="form-group">
            <label>åœ–ç‰‡ / æˆªåœ– (Ctrl+V)</label>
            <div class="paste-zone" id="pasteZone" onclick="document.getElementById('edit_img_file').click()">
                é»æ“Šä¸Šå‚³ æˆ– ç›´æ¥è²¼ä¸Šæˆªåœ– (Ctrl+V)
                <br><span style="font-size:11px; color:#999;">(ç³»çµ±å°‡è‡ªå‹•å£“ç¸®åœ–ç‰‡)</span>
            </div>
            <input type="file" id="edit_img_file" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            <img id="edit_img_preview" class="img-preview-box">
            <input type="hidden" id="edit_img_base64">
            <button class="btn btn-revert" type="button" style="margin-top:5px;" onclick="clearImage()">æ¸…é™¤åœ–ç‰‡</button>
        </div>

        <div style="text-align:right; margin-top:15px;">
            <button class="btn btn-cancel" onclick="document.getElementById('editItemModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveEditedItem()">å„²å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<div id="batchInputModal" class="modal">
    <div class="modal-content modal-large">
        <h3 style="margin-top:0;">ğŸ“ å»£å‘Šæè³ªæ‰¹æ¬¡æ–°å¢</h3>
        <p style="font-size:13px; color:#666;">ç›´æ¥è¼¸å…¥å“åã€é•·å¯¬ï¼Œç³»çµ±å°‡è‡ªå‹•çµ„åˆè¦æ ¼ã€‚</p>
        <input type="hidden" id="batch_orderId">
        
        <div style="max-height:60vh; overflow-y:auto; margin-bottom:15px;">
            <table class="batch-table">
                <thead>
                    <tr>
                        <th style="width:25%">å“å (å¯é¸/å¯è¼¸)</th>
                        <th style="width:12%">é•·</th>
                        <th style="width:12%">å¯¬</th>
                        <th style="width:10%">æ•¸é‡</th>
                        <th style="width:10%">å–®ä½</th>
                        <th style="width:20%">å‚™è¨»</th>
                        <th style="width:5%"></th>
                    </tr>
                </thead>
                <tbody id="batchTableBody"></tbody>
            </table>
            <button class="btn-add-row" onclick="addBatchRow()">+ æ–°å¢ä¸€è¡Œ</button>
        </div>

        <div style="text-align:right;">
            <button class="btn btn-cancel" onclick="document.getElementById('batchInputModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitBatchInput()">ç¢ºèªåŒ¯å…¥</button>
        </div>
    </div>
</div>

<div id="configModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">â˜ï¸ é›²ç«¯è¨­å®š</h3>
        <input type="text" id="api_url_input" placeholder="Google Script URL..." style="width:100%; margin-bottom:20px;">
        <div style="text-align:right;">
            <button class="btn btn-cancel" onclick="document.getElementById('configModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveConfig()">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="dataModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
        <p style="color:#555; font-size:13px;">å®šæœŸå‚™ä»½å¯é˜²æ­¢ç¶²è·¯ç•°å¸¸å°è‡´è³‡æ–™æµå¤±ã€‚</p>
        
        <div style="background:#ecfdf5; padding:15px; border-radius:8px; border:1px solid #10b981; margin-bottom:20px; text-align:center;">
            <h4 style="margin:0 0 10px 0; color:#047857;">æ­¥é©Ÿ 1ï¼šå‚™ä»½ (ä¸‹è¼‰)</h4>
            <button class="btn" style="background:#059669; color:white; width:100%; font-size:15px;" onclick="backupData()">ğŸ“¥ ä¸‹è¼‰ JSON å‚™ä»½æª”</button>
        </div>

        <div style="background:#fff1f2; padding:15px; border-radius:8px; border:1px solid #f43f5e; text-align:center;">
            <h4 style="margin:0 0 10px 0; color:#be123c;">æ­¥é©Ÿ 2ï¼šé‚„åŸ (åŒ¯å…¥)</h4>
            <p style="font-size:12px; color:#be123c; margin-bottom:10px;">âš ï¸ è­¦å‘Šï¼šé‚„åŸå°‡è¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼</p>
            <button class="btn" style="background:#e11d48; color:white; width:100%; font-size:15px;" onclick="triggerRestore()">ğŸ“¤ é¸å–å‚™ä»½æª”é‚„åŸ</button>
            <input type="file" id="restoreFile" style="display: none;" accept=".json" onchange="restoreData(this)">
        </div>

        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-cancel" onclick="document.getElementById('dataModal').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="factoryDetailModal" class="modal">
    <div class="modal-content modal-full">
        <div class="modal-header-bar">
            <div>
                <h3 style="margin:0;" id="fdTitle">å·¥å» åç¨±</h3>
                <div style="font-size:12px; color:#666;" id="fdSubtitle">æ¸…é»æ¸…å–® (é»æ“Šå·²å–æœƒè‡ªå‹•å„²å­˜)</div>
            </div>
            <button class="btn btn-cancel" onclick="closeFactoryModal()">âŒ é—œé–‰</button>
        </div>
        <div class="modal-body" id="fdBody"></div>
    </div>
</div>

<div id="exceptionPopup" class="exception-popup">
    <h3 style="margin-top:0;">âš ï¸ è™•ç†æœªå–è²¨/ç•°å¸¸é …ç›®</h3>
    <input type="hidden" id="ex_tid">
    <input type="hidden" id="ex_uid">
    <p>æ‚¨å°‡ä»¥ä¸‹é …ç›®æ¨™è¨˜ç‚º <span style="font-weight:bold; color:red;">æœªå–/ç•°å¸¸</span>ï¼Œè«‹é¸æ“‡å¾ŒçºŒå‹•ä½œï¼š</p>
    <div id="exItemInfo" style="background:#f3f4f6; padding:10px; border-radius:4px; margin-bottom:15px; font-size:14px; font-weight:bold;"></div>
    <div style="display:flex; gap:10px;">
        <button class="btn" style="flex:1; background:#ef4444; color:white;" onclick="processException('return')">â†©ï¸ é€€å›è¨‚å–®æ± </button>
        <button class="btn" style="flex:1; background:#f59e0b; color:white;" onclick="processException('delay')">ğŸ“… ç§»è‡³æ˜æ—¥åˆä½µ</button>
    </div>
    <div style="text-align:center; margin-top:10px;">
        <button class="btn btn-cancel" onclick="closeExceptionPopup()" style="width:100%;">å–æ¶ˆæ“ä½œ</button>
    </div>
</div>

<div id="workOrderModal" class="modal">
    <div class="work-order-paper">
        <div class="wo-title">æ–½å·¥æ´¾å·¥å–®</div>
        <div class="wo-header-grid">
            <div class="wo-row"><div class="wo-label">æ¡ˆåï¼š</div><div class="wo-value" id="woCust"></div></div>
            <div class="wo-row"><div class="wo-label">æ—¥æœŸï¼š</div><div class="wo-value" id="woDate"></div></div>
            <div class="wo-row"><div class="wo-label">è¯çµ¡äººï¼š</div><div class="wo-value" id="woContact"></div></div>
            <div class="wo-row"><div class="wo-label">é›»è©±ï¼š</div><div class="wo-value" id="woPhone"></div></div>
            <div class="wo-row" style="grid-column:1/-1;"><div class="wo-label">åœ°å€ï¼š</div><div class="wo-value" id="woAddress"></div></div>
            <div class="wo-row" style="grid-column:1/-1;"><div class="wo-label">æ–½å·¥äººå“¡ï¼š</div><div class="wo-value" id="woWorker"></div></div>
        </div>

        <table class="wo-table">
            <thead>
                <tr>
                    <th style="width:5%">#</th>
                    <th style="width:30%">æ–½å·¥é …ç›®</th>
                    <th style="width:20%">è¦æ ¼/å°ºå¯¸</th>
                    <th style="width:45%">ç¤ºæ„åœ–/èªªæ˜ (è‹¥ç„¡åœ–å¯é»æ“Šä¸Šå‚³)</th>
                </tr>
            </thead>
            <tbody id="woItemsBody"></tbody>
        </table>

        <div style="margin-top:20px;">
            <strong>å‚™è¨»äº‹é …ï¼š</strong>
            <div id="woNote" style="border:1px solid black; min-height:100px; padding:10px; margin-top:5px; font-size:15px;"></div>
        </div>

        <div class="no-print" style="margin-top:30px; text-align:center; display:flex; gap:10px; justify-content:center;">
            <button class="btn btn-cancel" onclick="document.getElementById('workOrderModal').style.display='none'">é—œé–‰</button>
            <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / å­˜ç‚ºPDF</button>
        </div>
    </div>
</div>

<datalist id="vendorList"></datalist>
<datalist id="addressHistory"></datalist>
<datalist id="sharedProductList"></datalist>

<script>
    let API_URL = 'https://script.google.com/macros/s/AKfycby5XUwZ9Cs5_67KSCmdBSZkRlKoBPif6j4t9PpZzievIVjN7T6lry5AlTVD-N7OufdN/exec';
    
    let db = {
        cloudOrders: [],   manualOrders: [],  logistics: [],
        vendors: [],       hiddenOrders: [],  savedAddresses: []
    };

    let currentFactoryContext = { name: '', date: '', mode: '' };

    let selectedItems = []; 
    let currentMode = '';

    const PRODUCT_CATALOG = [
        "PPäº®", "PPéœ§", "PVCéœ§", "PVCäº®", "å…¨é€äº®", "å…¨é€éœ§",
        "åŠé€äº®", "åŠé€éœ§", "é›™é€å¸ƒ", "å–®é€å¸ƒ", "æ²¹ç•«å¸ƒ", "æ–œç´‹å¸ƒ",
        "åˆæˆæ¿", "å¼·å…‰æ¿", "ç™¼æ³¡æ¿", "ä¸­ç©ºæ¿", "ç„¡æ¥ç¸«", "å£“å…‹åŠ›",
        "ç«‹é«”ç™¼å…‰å­—", "éœ“è™¹ç‡ˆå­—", "æ‹›ç‰Œç‡ˆç®±", "å£“å…‹åŠ›ç‡ˆç®±"
    ];

    function initProductDatalist() {
        const dl = document.getElementById('sharedProductList');
        dl.innerHTML = PRODUCT_CATALOG.map(p => `<option value="${p}">`).join('');
    }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        let color = '#';
        for (let i = 0; i < 3; i++) {
            let value = (hash >> (i * 8)) & 0xFF;
            value = Math.floor((value + 180) / 2);
            color += ('00' + value.toString(16)).substr(-2);
        }
        return color;
    }
    
    function getContrastYIQ(hexcolor){
        hexcolor = hexcolor.replace("#", "");
        var r = parseInt(hexcolor.substr(0,2),16);
        var g = parseInt(hexcolor.substr(2,2),16);
        var b = parseInt(hexcolor.substr(4,2),16);
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        return (yiq >= 128) ? '#1f2937' : 'white';
    }

window.onload = function() {
        // â˜…â˜…â˜… ä¿®æ­£ 1ï¼šé˜²æ­¢ Edge ç€è¦½å™¨é˜»æ“‹æœ¬åœ°å„²å­˜å°è‡´ç•¶æ©Ÿ â˜…â˜…â˜…
        try {
            const savedUrl = localStorage.getItem('erp_api_url');
            if(savedUrl) API_URL = savedUrl;
        } catch(e) {
            console.log("ç€è¦½å™¨é˜»æ“‹äº†æœ¬åœ°å„²å­˜ï¼Œæ”¹ç”¨é è¨­ç¶²å€");
        }
        
        db = { cloudOrders: [], manualOrders: [], logistics: [], vendors: [], hiddenOrders: [], savedAddresses: [] };
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
        document.getElementById('dashDate').innerText = `(${today})`;
        
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';

        // Paste event for images
        document.getElementById('pasteZone').addEventListener('paste', handlePasteImage);

        initProductDatalist(); 
        syncCloud(); 
    };

    // --- Core Logic ---
    function clearFilters() {
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';
        document.getElementById('filterKeyword').value = '';
        renderPool();
    }

    function updateDashboard() {
        const today = new Date().toISOString().split('T')[0];
        
        // 1. è¨ˆç®—ä»Šæ—¥çµ±è¨ˆ
        const tasks = db.logistics.filter(t => t.date === today);
        let counts = { self: 0, freight: 0, install: 0 };
        tasks.forEach(t => { if(counts[t.mode] !== undefined) counts[t.mode]++; });
        
        document.getElementById('count-self').innerText = counts.self;
        document.getElementById('count-freight').innerText = counts.freight;
        document.getElementById('count-install').innerText = counts.install;
        document.getElementById('dashDate').innerText = `(${today})`;

        // 2. ğŸ”´ é€¾æœŸæª¢æŸ¥é‚è¼¯
        const overdueTasks = db.logistics.filter(t => {
            return t.status !== 'done' && t.date <= today;
        });

        const alertBox = document.getElementById('overdueAlert');
        const alertCount = document.getElementById('overdueCount');

        if (overdueTasks.length > 0) {
            alertBox.style.display = 'flex'; 
            alertCount.innerText = overdueTasks.length;
        } else {
            alertBox.style.display = 'none'; 
        }

        renderUpcomingPanel();
    }

    function openReportModal() {
        const today = new Date().toISOString().split('T')[0];
        const unfinished = db.logistics.filter(t => t.status !== 'done' && t.date <= today).sort((a,b) => a.date.localeCompare(b.date));
        const completed = db.logistics.filter(t => t.status === 'done' && t.date === today);

        const renderList = (tasks) => {
            if(tasks.length === 0) return '<div style="color:#999; text-align:center; padding:10px;">ç„¡è³‡æ–™</div>';
            return tasks.map(t => {
                const badgeClass = t.mode === 'self' ? 'tm-self' : (t.mode === 'freight' ? 'tm-freight' : 'tm-install');
                const badgeText = t.mode === 'self' ? 'è‡ªé€' : (t.mode === 'freight' ? 'è²¨é‹' : 'æ–½å·¥');
                const itemsCount = t.items.length;
                const distinctCust = [...new Set(t.items.map(i=>i.cust))].join('/');
                const loc = t.address || t.factory || 'æœªæŒ‡å®šåœ°é»';
                
                return `<div class="report-list-item">
                    <div>
                        <span class="tag-mode ${badgeClass}">${badgeText}</span>
                        <span style="font-weight:bold;">${t.date}</span> ${distinctCust}
                        <br><span style="color:#666; margin-left:5px;">ğŸ“ ${loc} (${itemsCount}ä»¶)</span>
                    </div>
                    ${t.status !== 'done' ? `<button class="btn btn-sm btn-success" onclick="completeTask(${t.id}); openReportModal();">å®Œæˆ</button>` : '<span style="color:green;">âœ…</span>'}
                </div>`;
            }).join('');
        };

        document.getElementById('listUnfinished').innerHTML = renderList(unfinished);
        document.getElementById('listCompleted').innerHTML = renderList(completed);
        document.getElementById('reportModal').style.display = 'flex';
    }
    
   function renderUpcomingPanel() {
        const todayStr = new Date().toISOString().split('T')[0];
        const futureTasks = db.logistics.filter(t => t.date > todayStr);
        futureTasks.sort((a,b) => a.date.localeCompare(b.date));
        
        const modes = { self: 'up-self', freight: 'up-freight', install: 'up-install' };
        
        Object.keys(modes).forEach(mode => {
            const container = document.getElementById(modes[mode]);
            const filtered = futureTasks.filter(t => t.mode === mode);
            
            if(filtered.length === 0) {
                container.innerHTML = `<div style="color:#999; font-size:12px; padding:5px;">ç„¡æ’ç¨‹</div>`;
            } else {
                container.innerHTML = filtered.map(t => {
                    const distinctCusts = [...new Set(t.items.map(i => i.cust))];
                    let info = distinctCusts.join(' / ') || 'æœªæŒ‡å®šå®¢æˆ¶';
                    
                    const detailList = t.items.map(i => 
                        `<div class="up-tooltip-row"><span>â€¢ ${i.name}</span><span style="color:#9ca3af; margin-left:10px;">${i.spec || ''}</span></div>`
                    ).join('');

                    const factoryInfo = t.factory ? `<div style="color:#fbbf24; margin-bottom:5px; font-weight:bold;">ğŸ  ${t.factory}</div>` : '';
                    
                    return `
                    <div class="up-item">
                        <div class="up-date">${t.date.slice(5)}</div>
                        <div class="up-info">${info}</div>
                        
                        <div class="up-tooltip">
                            ${factoryInfo}
                            <span class="up-tooltip-title">${info}</span>
                            ${detailList}
                        </div>
                    </div>`;
                }).join('');
            }
        });
    }

    function editTaskItemNote(tid, uid){ 
        const t = db.logistics.find(x => x.id == tid); 
        if(!t) return; 
        
        if(uid) {
            const i = t.items.find(x => x.uid == uid); 
            if(!i) return; 
            const n = prompt("ä¿®æ”¹å‚™è¨»:", i.note || ""); 
            if(n !== null) { i.note = n; pushToCloud(); renderViews(); }
        } else {
            const n = prompt("ä¿®æ”¹ä»»å‹™å‚™è¨»:", t.note || ""); 
            if(n !== null) { t.note = n; pushToCloud(); renderViews(); }
        }
    }

    function returnToPool(tid,uid){ if(!confirm('âš ï¸ é€€å›è¨‚å–®æ± ï¼Ÿ'))return; removeItemFromTask(tid, uid); renderViews(); renderPool(); updateDashboard(); }
    
    function removeItemFromTask(tid, uid) {
        const idx = db.logistics.findIndex(t => t.id == tid);
        if(idx === -1) return;
        
        const item = db.logistics[idx].items.find(i => i.uid === uid);
        if(item) {
             const originId = item.orderId; 
             let originalOrder = db.manualOrders.find(o => o.id == originId);
             if(!originalOrder) originalOrder = db.cloudOrders.find(o => o.id == originId);

             if(originalOrder) {
                 if(!originalOrder.items) originalOrder.items = [];
                 originalOrder.items.push({ name: item.name, spec: item.spec, w: item.w, h: item.h, note: item.note, img: item.img }); 
                 db.hiddenOrders = db.hiddenOrders.filter(hid => hid !== String(originId));
             } else {
                 db.manualOrders.unshift({
                     id: originId || 'RESTORED-' + Date.now(),
                     date: new Date().toISOString().split('T')[0],
                     cust: item.cust || 'é‚„åŸè¨‚å–®',
                     items: [{ name: item.name, spec: item.spec, w: item.w, h: item.h, note: item.note, img: item.img }],
                     isManual: true
                 });
             }
             pushToCloud();
        }

        db.logistics[idx].items = db.logistics[idx].items.filter(i => i.uid !== uid);
        if(db.logistics[idx].items.length === 0) db.logistics.splice(idx, 1);
        pushToCloud();
    }

    function restoreOrder(id) { 
        if(!confirm('é‚„åŸï¼Ÿ')) return; 
        db.hiddenOrders = db.hiddenOrders.filter(x => x !== String(id)); 
        pushToCloud(); 
        renderPool(); 
    }

    async function syncCloud() {
        setLoading(true);
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            if(data) {
                db.cloudOrders = data.o || [];
                db.logistics = data.l || [];
                db.manualOrders = data.mo || [];
                db.hiddenOrders = data.ho || [];
                db.savedAddresses = data.addr || [];

                if(data.p) { db.vendors = data.p.filter(p => p.type === 'v').map(p => p.name); updateVendorList(); }
                updateAddressDatalist(); 
                renderPool(); renderViews(); updateDashboard(); setLoading(false, true);
            }
        } catch(e) { setLoading(false, false); }
    }

async function pushToCloud() {
        setLoading(true);
        try {
            // å»ºç«‹å°ˆç”¨çš„ payloadï¼Œè€Œä¸æ˜¯è®€å–å¾Œå†è¦†è“‹
            const payload = {
                action: 'save_shipping',
                logistics: db.logistics,
                manualOrders: db.manualOrders,
                hiddenOrders: db.hiddenOrders,
                savedAddresses: db.savedAddresses
            };

            const res = await fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify(payload)
            });
            
            setLoading(false, true);
            updateDashboard();
        } catch(e) { 
            console.error(e);
            setLoading(false, false); 
            alert('âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); 
        }
    }
    function setLoading(isLoading, isOk) {
        const dot = document.getElementById('cloudDot');
        if(isLoading) dot.className='dot loading';
        else { dot.className= isOk?'dot ok':'dot'; dot.style.background=isOk?'':'red'; document.getElementById('cloudText').innerText=isOk?'å·²é€£ç·š':'æ–·ç·š'; }
    }

    function updateVendorList() { document.getElementById('vendorList').innerHTML = db.vendors.map(v => `<option value="${v}">`).join(''); }
    function checkAndSaveAddress(addr) { 
        if (addr && addr.trim()!=='' && addr!=='ç¸½å…¬å¸' && !db.savedAddresses.includes(addr)) { 
            db.savedAddresses.push(addr); 
            pushToCloud(); 
            updateAddressDatalist(); 
        } 
    }
    function updateAddressDatalist() { document.getElementById('addressHistory').innerHTML = db.savedAddresses.map(a => `<option value="${a}">`).join(''); }

    function renderPool() {
        const container = document.getElementById('itemsPool');
        container.innerHTML = '';
        selectedItems = [];
        const dispatchedIds = new Set();
        db.logistics.forEach(t => t.items.forEach(i => dispatchedIds.add(i.uid)));
        let allOrders = [...db.manualOrders, ...db.cloudOrders];
        const startDate = document.getElementById('filterStart').value;
        const endDate = document.getElementById('filterEnd').value;
        const keyword = document.getElementById('filterKeyword').value.toLowerCase();
        const showHidden = document.getElementById('showHidden').checked;
        let visibleCount = 0, hiddenCount = 0;

        allOrders.forEach(order => {
            let oDate = order.date ? order.date.replace(/\//g, '-') : '';
            if (startDate && oDate < startDate) return;
            if (endDate && oDate > endDate) return;
            if (keyword && !String(order.id).toLowerCase().includes(keyword) && !String(order.cust).toLowerCase().includes(keyword)) return;
            
            const isHidden = db.hiddenOrders.includes(String(order.id));
            if(isHidden) hiddenCount++;
            if(isHidden && !showHidden) return;
            if(!order.items || order.items.length === 0) return;
            visibleCount++;

            const isManual = String(order.id).startsWith('TEMP-') || String(order.id).startsWith('RET-');
            const allDispatched = order.items.every((item, idx) => dispatchedIds.has(`${order.id}_${idx}`));
            
            let contactInfo = [];
            if(order.contact) contactInfo.push(`ğŸ‘¤ ${order.contact}`);
            if(order.phone) contactInfo.push(`ğŸ“ ${order.phone}`);
            if(order.address) contactInfo.push(`ğŸ“ ${order.address}`);

            container.innerHTML += `
            <div class="order-group ${isManual?'manual':''} ${isHidden?'is-hidden-order':''}" style="opacity:${allDispatched?0.7:1}">
                <div class="order-header" onclick="toggleOrder('${order.id}')">
                    <div class="header-top">
                        <span>${isManual?'ğŸ“':'ğŸ“„'} ${order.id} (${order.cust}) [${order.date}] ${isHidden?'(å·²éš±è—)':''}</span>
                        <div class="order-actions">
                             ${isHidden ? `<button class="act-btn" onclick="event.stopPropagation(); restoreOrder('${order.id}')" style="color:green;border-color:green;">é‚„åŸ</button>` :
                                `${!allDispatched ? '<button class="act-btn" style="background:#2563eb;color:white;border:none;">å…¨é¸</button>' : ''}
                                <button class="act-btn" onclick="event.stopPropagation(); openBatchInputModal('${order.id}')" title="æ‰¹æ¬¡æ–°å¢">â• æ‰¹æ¬¡</button>
                                <button class="act-btn act-del" onclick="event.stopPropagation(); deleteOrder('${order.id}')">éš±è—</button>`}
                        </div>
                    </div>
                    ${contactInfo.length > 0 ? `<div class="header-info">${contactInfo.join(' | ')}</div>` : ''}
                </div>
                <div class="order-items" style="display:${isHidden?'none':'block'}">
${order.items.map((item, idx) => {
    const uid = `${order.id}_${idx}`;
    const isScheduled = dispatchedIds.has(uid);
    const hasImg = !!item.img;
    return `
    <div class="item-card ${isScheduled ? 'disabled' : ''}" id="card-${uid}" 
            onclick="${(isScheduled || isHidden) ? '' : `toggleItem('${order.id}', ${idx}, '${uid}')`}">
        <div class="checkbox-mock"></div>
        <div style="flex:1">
            <div style="font-weight:bold; font-size:14px;">${item.name} 
                ${hasImg ? `<span class="img-icon" onclick="event.stopPropagation(); showImage('${uid}', '${item.img}')" title="æŸ¥çœ‹åœ–ç‰‡">ğŸ“·</span>` : ''}
            </div>
            <div style="font-size:13px; color:#666;">
                ${item.spec||''} ${(item.w||item.h) ? `(${item.w||'?'}x${item.h||'?'})` : ''}
            </div>
            ${item.note?`<div style="font-size:12px; color:#dc2626; font-weight:bold;">âš ï¸ ${item.note}</div>`:''}
        </div>
        ${isScheduled ? '<span class="status-tag tag-scheduled">å·²æ’ç¨‹</span>' : 
        `<div class="item-controls" onclick="event.stopPropagation()">
            <button class="btn-icon-sm btn-icon-edit" onclick="openEditItemModal('${order.id}', ${idx})">âœï¸</button>
            <button class="btn-icon-sm btn-icon-del" onclick="deleteItemInPool('${order.id}', ${idx})">ğŸ—‘ï¸</button>
        </div>` }
    </div>
    `; 
}).join('')}
            </div> </div> `; // è£œä¸Šï¼šçµæŸ HTML æ¨¡æ¿å­—ä¸²
    }); // è£œä¸Šï¼šçµæŸ forEach è¿´åœˆ
    
    document.getElementById('poolStats').innerText = `é¡¯ç¤º ${visibleCount} ç­† (éš±è— ${hiddenCount} ç­†)`;
    if(container.innerHTML === '') container.innerHTML = '<div style="text-align:center; padding:30px; color:#999; font-size:14px;">ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>';
}

    function toggleItem(orderId, idx, uid) {
        const card = document.getElementById(`card-${uid}`);
        if(card.classList.contains('disabled')) return; 
        const existingIdx = selectedItems.findIndex(x => x.uid === uid);
        if(existingIdx >= 0) { selectedItems.splice(existingIdx, 1); card.classList.remove('selected'); } 
        else {
            let order = db.manualOrders.find(o => o.id == orderId) || db.cloudOrders.find(o => o.id == orderId);
            const item = order.items[idx];
            selectedItems.push({ 
                uid: uid, orderId: orderId, cust: order.cust, 
                name: item.name, spec: item.spec, w: item.w, h: item.h, note: item.note,
                img: item.img // Pass image
            });
            card.classList.add('selected');
        }
        updateSummary();
    }
    function toggleOrder(orderId) {
        if(db.hiddenOrders.includes(String(orderId))) return; 
        const cards = document.querySelectorAll(`[id^="card-${orderId}_"]:not(.disabled)`);
        if(cards.length === 0) return;
        const allSelected = Array.from(cards).every(c => c.classList.contains('selected'));
        cards.forEach(c => {
            if(allSelected) { if(c.classList.contains('selected')) c.click(); }
            else { if(!c.classList.contains('selected')) c.click(); }
        });
    }

    function updateSummary() { document.getElementById('selectedItemsSummary').innerText = `å·²é¸å– ${selectedItems.length} é …`; }
    
    function createManualOrder() { 
        const id = 'TEMP-' + Date.now(); 
        db.manualOrders.unshift({ id: id, date: new Date().toISOString().split('T')[0], cust: 'è‡¨æ™‚å‡ºè²¨', address:'', contact:'', phone:'', items: [], isManual: true }); 
        pushToCloud(); 
        renderPool(); 
        openBatchInputModal(id);
    }
    
// â˜…â˜…â˜… ä¿®æ­£ 2ï¼šç™¼é€ delete_item æŒ‡ä»¤ï¼Œå¼·åˆ¶é›²ç«¯åˆªé™¤ â˜…â˜…â˜…
    function deleteOrder(id) { 
        // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œè‡¨æ™‚å–®ã€æˆ–ã€Œé€€å›å–®ã€(åªæœ‰é€™äº›æ˜¯å­˜åœ¨è³‡æ–™åº«çš„ mo æ¬„ä½ï¼Œéœ€è¦çœŸåˆªé™¤)
        if(id.startsWith('TEMP-') || id.startsWith('RET-')) { 
            if(!confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤è‡¨æ™‚å–®ï¼Ÿ')) return; 
            
            // 1. æœ¬åœ°ç§»é™¤ (è®“ç•«é¢å…ˆè®Š)
            db.manualOrders = db.manualOrders.filter(o => o.id !== id); 
            renderPool(); 

            // 2. ç™¼é€å°ˆç”¨åˆªé™¤æŒ‡ä»¤çµ¦é›²ç«¯ (é—œéµæ­¥é©Ÿï¼)
            setLoading(true);
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: 'delete_item',
                    type: 'mo',  // mo ä»£è¡¨æ‰‹å‹•è¨‚å–® (Manual Orders)
                    id: id
                })
            }).then(()=>{
                setLoading(false, true);
            }).catch(e => {
                // å¿½ç•¥éŒ¯èª¤ï¼Œé¿å…ç¶²è·¯ä¸ç©©æ™‚ä¸€ç›´è·³çª—
                setLoading(false, true);
            });

        } else { 
            // é€™æ˜¯æ­£å¼è¨‚å–®ï¼ŒåŸ·è¡Œã€Œéš±è—ã€ (é€™éƒ¨åˆ†ç¶­æŒåŸæ¨£)
            if(!confirm('ç¢ºå®šè¦å°‡æ­¤å–®éš±è—ï¼Ÿ(å¯å¾ç¯©é¸ä¸­æ‰¾å›)')) return; 
            db.hiddenOrders.push(String(id)); 
            pushToCloud(); 
            renderPool(); 
        } 
    }    
function deleteItemInPool(oid, idx) {
    if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´°é …å—ï¼Ÿ')) return;

    let order = db.manualOrders.find(o => o.id == oid);
    let isManual = true;

    if(!order) { 
        order = db.cloudOrders.find(o => o.id == oid); 
        isManual = false; 
    }

    if(order && order.items[idx]) {
        order.items.splice(idx, 1);

        // å¦‚æœæ˜¯æ‰‹å‹•å–®ä¸”é …ç›®å·²æ¸…ç©ºï¼Œåˆªé™¤æ•´å¼µå–®
        if(isManual && order.items.length === 0) {
            db.manualOrders = db.manualOrders.filter(o => o.id !== oid);
        }

        if(isManual) {
            pushToCloud(); 
        }
        renderPool();
    }
}

    // === EDIT ITEM IN POOL (With Image) ===
    function openEditItemModal(oid, idx) {
        let order = db.manualOrders.find(o => o.id == oid) || db.cloudOrders.find(o => o.id == oid);
        if(!order || !order.items[idx]) return;
        
        const item = order.items[idx];
        document.getElementById('edit_oid').value = oid;
        document.getElementById('edit_idx').value = idx;
        document.getElementById('edit_name').value = item.name || '';
        document.getElementById('edit_len').value = item.w || '';
        document.getElementById('edit_wid').value = item.h || '';
        document.getElementById('edit_qty').value = ''; 
        document.getElementById('edit_note').value = item.note || '';
        
        const imgPrev = document.getElementById('edit_img_preview');
        const imgHidden = document.getElementById('edit_img_base64');
        if(item.img) {
            imgPrev.src = item.img;
            imgPrev.classList.add('show');
            imgHidden.value = item.img;
        } else {
            clearImageUI();
        }
        
        document.getElementById('editItemModal').style.display = 'flex';
    }

    function handleImageUpload(input) {
        if(input.files && input.files[0]) {
            processImageFile(input.files[0], (base64) => {
                document.getElementById('edit_img_preview').src = base64;
                document.getElementById('edit_img_preview').classList.add('show');
                document.getElementById('edit_img_base64').value = base64;
            });
        }
    }

    function handlePasteImage(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {
                const blob = item.getAsFile();
                processImageFile(blob, (base64) => {
                    document.getElementById('edit_img_preview').src = base64;
                    document.getElementById('edit_img_preview').classList.add('show');
                    document.getElementById('edit_img_base64').value = base64;
                });
            }
        }
    }

    function processImageFile(file, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 800;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                callback(dataUrl);
            }
        }
        reader.readAsDataURL(file);
    }

    function clearImage() {
        clearImageUI();
        document.getElementById('edit_img_file').value = '';
    }
    
    function clearImageUI() {
        document.getElementById('edit_img_preview').src = '';
        document.getElementById('edit_img_preview').classList.remove('show');
        document.getElementById('edit_img_base64').value = '';
    }

    function showImage(uid, src) {
        const w = window.open("", "_blank");
        w.document.write(`<img src="${src}" style="max-width:100%;">`);
    }

    function saveEditedItem() {
        const oid = document.getElementById('edit_oid').value;
        const idx = document.getElementById('edit_idx').value;
        let order = db.manualOrders.find(o => o.id == oid);
        let isCloud = false;
        if(!order) { order = db.cloudOrders.find(o => o.id == oid); isCloud = true; }
        
        if(order && order.items[idx]) {
            const name = document.getElementById('edit_name').value;
            const w = document.getElementById('edit_len').value;
            const h = document.getElementById('edit_wid').value;
            const qty = document.getElementById('edit_qty').value;
            const note = document.getElementById('edit_note').value;
            const img = document.getElementById('edit_img_base64').value;
            
            const sizeSpec = (w && h) ? `${w}x${h}` : (w || h || '');
            const fullSpec = [sizeSpec, qty?`x${qty}`:''].filter(Boolean).join(' ');

            order.items[idx].name = name;
            order.items[idx].spec = fullSpec;
            order.items[idx].w = w;
            order.items[idx].h = h;
            order.items[idx].note = note;
            order.items[idx].img = img; 

            if(!isCloud) pushToCloud(); 
            document.getElementById('editItemModal').style.display = 'none';
            renderPool();
        }
    }


    // === NEW SMART BATCH INPUT ===
    let batchRowCount = 0;

    function openBatchInputModal(oid) {
        document.getElementById('batch_orderId').value = oid;
        document.getElementById('batchTableBody').innerHTML = ''; 
        batchRowCount = 0;
        addBatchRow();
        addBatchRow();
        addBatchRow();
        document.getElementById('batchInputModal').style.display = 'flex';
    }

    function addBatchRow() {
        batchRowCount++;
        const tbody = document.getElementById('batchTableBody');
        const tr = document.createElement('tr');
        tr.id = `row-${batchRowCount}`;
        
        tr.innerHTML = `
            <td>
                <input type="text" id="name-${batchRowCount}" list="sharedProductList" placeholder="é¸æ“‡æˆ–è¼¸å…¥...">
            </td>
            <td><input type="text" id="len-${batchRowCount}" placeholder="é•·" style="text-align:center;"></td>
            <td><input type="text" id="wid-${batchRowCount}" placeholder="å¯¬" style="text-align:center;"></td>
            <td><input type="number" id="qty-${batchRowCount}" placeholder="1" style="text-align:center;"></td>
            <td><input type="text" id="unit-${batchRowCount}" placeholder="å¼" style="text-align:center;"></td>
            <td><input type="text" id="note-${batchRowCount}" placeholder="å‚™è¨»"></td>
            <td style="text-align:center;"><div class="row-del-btn" onclick="removeBatchRow(${batchRowCount})">âœ•</div></td>
        `;
        tbody.appendChild(tr);
    }

    function removeBatchRow(id) {
        const row = document.getElementById(`row-${id}`);
        if(row) row.remove();
    }

    function submitBatchInput() {
        const oid = document.getElementById('batch_orderId').value;
        let order = db.manualOrders.find(o=>o.id==oid);
        let isCloud = false;
        if(!order) { order = db.cloudOrders.find(o=>o.id==oid); isCloud=true; }
        if(!order) return;

        if(!order.items) order.items = [];

        const rows = document.getElementById('batchTableBody').querySelectorAll('tr');
        rows.forEach(row => {
            const id = row.id.split('-')[1];
            const name = document.getElementById(`name-${id}`).value;
            const length = document.getElementById(`len-${id}`).value;
            const width = document.getElementById(`wid-${id}`).value;
            const qty = document.getElementById(`qty-${id}`).value;
            const unit = document.getElementById(`unit-${id}`).value;
            const note = document.getElementById(`note-${id}`).value;

            if(name.trim()) {
                const sizeSpec = (length && width) ? `${length}x${width}` : (length || width || '');
                const fullSpec = [sizeSpec, qty?`x${qty}`:'', unit].filter(Boolean).join(' ');
                const fullNote = note ? note : '';
                
                order.items.push({
                    name: name,
                    spec: fullSpec,
                    note: fullNote,
                    w: length, 
                    h: width
                });
            }
        });

        if(!isCloud) pushToCloud(); 
        document.getElementById('batchInputModal').style.display = 'none';
        renderPool();
    }
    
    function openDispatchModal(mode) {
        if(selectedItems.length === 0) return alert('æœªé¸å–');
        
        currentMode = mode; 
        document.getElementById('dispatchModal').style.display = 'flex';
        
        document.querySelectorAll('.conditional-field').forEach(e => e.style.display = 'none');
        
        const firstItem = selectedItems[0];
        let sourceOrder = db.manualOrders.find(o => o.id == firstItem.orderId) ||
                          db.cloudOrders.find(o => o.id == firstItem.orderId);
        
        if (sourceOrder) {
            document.getElementById('modalAddress').value = sourceOrder.address || '';
            document.getElementById('modalContact').value = sourceOrder.contact || '';
            document.getElementById('modalPhone').value = sourceOrder.phone || '';
        } else {
            document.getElementById('modalAddress').value = '';
            document.getElementById('modalContact').value = '';
            document.getElementById('modalPhone').value = '';
        }

        document.getElementById('field-address').style.display = 'block';
        document.getElementById('field-contact').style.display = 'block';
        
        if(mode === 'install') {
            document.getElementById('field-installer').style.display = 'block';
            document.getElementById('lbl-address').innerText = "æ–½å·¥åœ°é»";
        } else if (mode === 'self') {
            document.getElementById('lbl-address').innerText = "é€è²¨åœ°å€";
        } else {
            document.getElementById('lbl-address').innerText = "è²¨é‹åœ°å€";
        }

        document.getElementById('modalNote').value = '';
        document.getElementById('modalWorker').value = '';
    }

    function closeModal() { document.getElementById('dispatchModal').style.display='none'; }
    function submitDispatch() {
        const newTask = {
            id: Date.now(), date: document.getElementById('modalDate').value, mode: currentMode, items: [...selectedItems],
            factory: document.getElementById('modalFactory').value, address: document.getElementById('modalAddress').value,
            note: document.getElementById('modalNote').value, worker: document.getElementById('modalWorker').value,
            contact: document.getElementById('modalContact').value, phone: document.getElementById('modalPhone').value, time: document.getElementById('modalTime').value,
            status: 'pending' 
        };
        checkAndSaveAddress(newTask.address);
        db.logistics.push(newTask); pushToCloud(); closeModal(); selectedItems=[]; renderPool(); renderViews();
    }
    function switchView(v) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); renderViews(); }
    function renderViews() {
        if(document.getElementById('view-dispatcher').classList.contains('active')) renderPool();
        if(document.getElementById('view-driver').classList.contains('active')) renderDriverView();
        if(document.getElementById('view-freight').classList.contains('active')) renderFreightView();
        if(document.getElementById('view-installer').classList.contains('active')) renderInstallView();
    }
    function sortTasksByAddress(tasks) { return tasks.sort((a, b) => (a.address||'').localeCompare(b.address||'', 'zh-Hant')); }
    
    function renderDriverView() { 
        const d = document.getElementById('driverDate').value; 
        let tasks = db.logistics.filter(x => x.mode==='self' && x.date===d); 
        tasks = sortTasksByAddress(tasks);
        
        document.getElementById('driverPickupContent').innerHTML = generatePickupSummary(tasks, 'self');
        document.getElementById('driverRouteTimeline').innerHTML = generateRoutePlanner(tasks, 'routeStart');
        document.getElementById('driverContent').innerHTML = generateTaskHTML(tasks, 'address'); 
    }

    function renderFreightView() { const d=document.getElementById('freightDate').value; const t=db.logistics.filter(x=>x.mode==='freight'&&x.date===d); document.getElementById('freightPickupContent').innerHTML=generatePickupSummary(t,'freight'); document.getElementById('freightContent').innerHTML=generateTaskHTML(t,'factory'); }
    
    function renderInstallView() { 
        const d = document.getElementById('installDate').value; 
        let tasks = db.logistics.filter(x => x.mode === 'install' && x.date === d); 
        
        tasks = sortTasksByAddress(tasks);

        document.getElementById('installPickupContent').innerHTML = generatePickupSummary(tasks, 'install');
        document.getElementById('installRouteTimeline').innerHTML = generateRoutePlanner(tasks, 'installRouteStart');
        document.getElementById('installContent').innerHTML = generateTaskHTML(tasks, 'worker'); 
    }
    
    // === WORK ORDER (PRINT) GENERATOR ===
    let currentWorkOrderTaskId = null;

    function openWorkOrder(taskId) {
        currentWorkOrderTaskId = taskId;
        const task = db.logistics.find(t => t.id === taskId);
        if(!task) return;

        // Populate Header
        const distinctCusts = [...new Set(task.items.map(i => i.cust))].join(' / ');
        document.getElementById('woCust').innerText = distinctCusts || 'æœªæŒ‡å®š';
        document.getElementById('woDate').innerText = task.date;
        document.getElementById('woContact').innerText = task.contact || '';
        document.getElementById('woPhone').innerText = task.phone || '';
        document.getElementById('woAddress').innerText = task.address || task.factory || '';
        document.getElementById('woWorker').innerText = task.worker || '';
        document.getElementById('woNote').innerText = task.note || '';

        // Populate Items Table
        const tbody = document.getElementById('woItemsBody');
        tbody.innerHTML = '';
        
        task.items.forEach((item, index) => {
            const tr = document.createElement('tr');
            
            // Image Cell Content
            let imgContent = '';
            if (item.img) {
                imgContent = `<div class="wo-img-cell">
                    <img src="${item.img}">
                    <label class="btn-upload-small">æ›´æ›åœ–ç‰‡<input type="file" style="display:none" onchange="uploadWorkOrderImg(this, '${task.id}', '${item.uid}')"></label>
                </div>`;
            } else {
                imgContent = `<label class="btn-upload-small">â• ä¸Šå‚³åœ–ç‰‡<input type="file" style="display:none" onchange="uploadWorkOrderImg(this, '${task.id}', '${item.uid}')"></label>`;
            }

            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div style="font-size:12px;color:#666;">(${item.cust || ''})</div>
                </td>
                <td>${item.spec || ''}</td>
                <td>${item.note ? `<div style="color:red;font-weight:bold;">è¨»ï¼š${item.note}</div>` : ''}${imgContent}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('workOrderModal').style.display = 'block';
    }

    function uploadWorkOrderImg(input, taskId, itemUid) {
        if(input.files && input.files[0]) {
            processImageFile(input.files[0], (base64) => {
                // Find and update data
                const task = db.logistics.find(t => t.id == taskId);
                if(task) {
                    const item = task.items.find(i => i.uid == itemUid);
                    if(item) {
                        item.img = base64;
                        pushToCloud();
                        // Re-render modal to show image
                        openWorkOrder(parseInt(taskId));
                    }
                }
            });
        }
    }


    function generatePickupSummary(tasks, m) { 
        if(tasks.length === 0) return '<div style="color:#999;grid-column:1/-1;text-align:center;">ç„¡å–è²¨ä»»å‹™</div>'; 
        
        const g = {}; 
        tasks.forEach(t => { 
            const f = t.factory || 'æœªæŒ‡å®š'; 
            if(!g[f]) g[f] = []; 
            g[f].push(t); 
        }); 
        
        return Object.keys(g).sort().map(f => {
            let total = g[f].reduce((a, b) => a + b.items.length, 0);
            
            let pickedCount = 0;
            g[f].forEach(t => t.items.forEach(i => { if(i.picked) pickedCount++; }));

            let previewHtml = g[f].map(t => {
                return t.items.map(i => 
                    `<div style="margin-bottom:2px; border-bottom:1px dashed #444; padding-bottom:2px;">
                        <span style="color:#93c5fd;">[${i.cust || '?'}]</span> ${i.name} 
                        ${i.picked ? 'âœ…' : ''}
                     </div>`
                ).join('');
            }).join('');

            return `<div class="factory-card" onclick="openFactoryModal('${f}','${m}', '${tasks[0].date}')">
                <div class="factory-tooltip">
                    <div style="font-weight:bold; border-bottom:1px solid #555; margin-bottom:5px; padding-bottom:3px;">ğŸ“‹ ${f} - æ˜ç´°é è¦½</div>
                    ${previewHtml}
                </div>
                <div class="factory-header" style="background:${stringToColor(f)};color:${getContrastYIQ(stringToColor(f))}">
                    <span>${f}</span><span>${pickedCount}/${total}ä»¶</span>
                </div>
                <div class="factory-body"><div style="font-size:12px;color:#666;text-align:center;">é»æ“Šé€²è¡Œæ¸…é» (æŒ‰å…¬å¸æ’åº)</div></div>
            </div>`;
        }).join(''); 
    }

    function openFactoryModal(factoryName, mode, date) {
        document.getElementById('fdTitle').innerText = factoryName;
        currentFactoryContext = { name: factoryName, date: date, mode: mode };

        const tasks = db.logistics.filter(t => t.date === date && (t.factory === factoryName) && t.mode === mode);
        const groupedByCust = {};
        
        tasks.forEach(task => {
            task.items.forEach(item => {
                const cust = item.cust || 'æœªæŒ‡å®šå®¢æˆ¶';
                if (!groupedByCust[cust]) groupedByCust[cust] = [];
                groupedByCust[cust].push({
                    ...item,
                    parentTaskId: task.id,
                    contact: task.contact,
                    phone: task.phone
                });
            });
        });

        let html = '';
        const sortedCusts = Object.keys(groupedByCust).sort();

        if(sortedCusts.length === 0) {
            html = '<div style="padding:20px;text-align:center;">ç„¡è³‡æ–™</div>';
        } else {
            sortedCusts.forEach(cust => {
                html += `<div class="fd-cust-header">
                    <span>ğŸ¢ ${cust}</span>
                    <div class="fd-spacer"></div>
                    <button class="btn-xs-batch batch-ret" onclick="batchProcessCust('${cust}', 'return')">â†©ï¸ å…¨é€€</button>
                    <button class="btn-xs-batch batch-mov" onclick="batchProcessCust('${cust}', 'delay')">ğŸ“… æ˜æ—¥</button>
                </div>`;
                
                groupedByCust[cust].forEach(item => {
                    const hasImg = !!item.img;
                    html += `
                    <div class="fd-item-card" id="fd-item-${item.parentTaskId}-${item.uid}">
                        <div class="fd-item-header">
                            <span>${item.name} 
                                ${hasImg ? `<span class="img-icon" onclick="event.stopPropagation(); showImage('${item.uid}', '${item.img}')">ğŸ“·</span>` : ''}
                            </span>
                            <span>${item.spec||''}</span>
                        </div>
                        <div style="font-size:12px; color:#555;">å–®è™Ÿ: ${item.orderId || 'N/A'} ${item.contact ? `| ğŸ‘¤ ${item.contact}` : ''}</div>
                        ${item.note ? `<div style="color:red; font-size:12px;">è¨»: ${item.note}</div>` : ''}
                        <div class="fd-actions">
                            <button class="fd-btn ${item.picked ? 'picked active' : 'picked'}" onclick="markPicked(this, '${item.parentTaskId}', '${item.uid}')">âœ… å·²å–</button>
                            <button class="fd-btn issue" onclick="openExceptionPopup('${item.parentTaskId}', '${item.uid}', '${item.name}')">âš ï¸ æœªå–</button>
                        </div>
                    </div>`;
                });
            });
        }
        
        document.getElementById('fdBody').innerHTML = html;
        document.getElementById('factoryDetailModal').style.display='flex';
    }

    function markPicked(btn, taskId, itemUid) {
        const isActive = btn.classList.toggle('active');
        const task = db.logistics.find(t => t.id == taskId);
        if(task) {
            const item = task.items.find(i => i.uid == itemUid);
            if(item) {
                item.picked = isActive; 
                pushToCloud();
            }
        }
    }
    
    function batchProcessCust(custName, action) {
        if(!confirm(`ç¢ºå®šè¦å°‡ã€Œ${custName}ã€çš„æ‰€æœ‰é …ç›® ${action==='return'?'é€€å›è¨‚å–®æ± ':'ç§»è‡³æ˜æ—¥'} å—ï¼Ÿ`)) return;

        const { name: fName, date: fDate, mode: fMode } = currentFactoryContext;
        const relevantTasks = db.logistics.filter(t => t.date === fDate && t.factory === fName && t.mode === fMode);
        
        let itemsToProcess = [];
        relevantTasks.forEach(task => {
            const custItems = task.items.filter(i => (i.cust || 'æœªæŒ‡å®šå®¢æˆ¶') === custName);
            custItems.forEach(item => {
                itemsToProcess.push({ taskId: task.id, uid: item.uid, itemData: item });
            });
        });

        if(itemsToProcess.length === 0) return alert('ç„¡é …ç›®å¯è™•ç†');

        if(action === 'return') {
            itemsToProcess.forEach(p => {
                removeItemFromTask(p.taskId, p.uid); 
            });
        } else if (action === 'delay') {
            let tomorrow = new Date(fDate);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextDate = tomorrow.toISOString().split('T')[0];
            
            itemsToProcess.forEach(p => {
                const taskIdx = db.logistics.findIndex(t => t.id == p.taskId);
                if(taskIdx === -1) return;
                
                const task = db.logistics[taskIdx];
                const itemIdx = task.items.findIndex(i => i.uid == p.uid);
                
                if(itemIdx !== -1) {
                    db.logistics.push({
                        ...task,
                        id: Date.now() + Math.random(),
                        date: nextDate,
                        items: [task.items[itemIdx]],
                        status: 'pending'
                    });
                    
                    task.items.splice(itemIdx, 1);
                    if(task.items.length === 0) db.logistics.splice(taskIdx, 1);
                }
            });
            pushToCloud();
        }

        closeFactoryModal();
        renderViews();
    }


    function openExceptionPopup(tid, uid, name) {
        document.getElementById('ex_tid').value = tid;
        document.getElementById('ex_uid').value = uid;
        document.getElementById('exItemInfo').innerText = name;
        document.getElementById('exceptionPopup').classList.add('show');
    }

    function closeExceptionPopup() { document.getElementById('exceptionPopup').classList.remove('show'); }

    function processException(action) {
        const tid = document.getElementById('ex_tid').value;
        const uid = document.getElementById('ex_uid').value;
        const taskIdx = db.logistics.findIndex(t => t.id == tid);
        
        if (taskIdx === -1) return;

        if (action === 'return') {
            removeItemFromTask(tid, uid); 
        } else if (action === 'delay') {
            const task = db.logistics[taskIdx];
            const itemIdx = task.items.findIndex(i => i.uid == uid);
            if(itemIdx !== -1) {
                const item = task.items[itemIdx];
                let tomorrow = new Date(task.date);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const nextDate = tomorrow.toISOString().split('T')[0];
                
                db.logistics.push({
                    ...task,
                    id: Date.now(),
                    date: nextDate,
                    items: [item]
                });
                
                task.items.splice(itemIdx, 1);
                if(task.items.length === 0) db.logistics.splice(taskIdx, 1);
                pushToCloud();
            }
        }
        
        closeExceptionPopup();
        closeFactoryModal();
        renderViews();
    }

    function closeFactoryModal(){ document.getElementById('factoryDetailModal').style.display='none'; }

    // === æ”¹è‰¯ç‰ˆï¼šè·¯å¾‘è¦åŠƒç”Ÿæˆå™¨ (æ”¯æ´æ‹–æ›³èˆ‡åœ–ç¤º) ===
    function generateRoutePlanner(tasks, startInputId) { 
        // 1. å–å¾—ä¸é‡è¤‡åœ°å€
        const uniqueAddresses = [...new Set(tasks.map(t => t.address).filter(a => a && a.trim() !== ''))];
        
        const startPointInput = document.getElementById(startInputId);
        const startPoint = (startPointInput ? startPointInput.value.trim() : 'ç¸½å…¬å¸') || 'ç¸½å…¬å¸';

        if(uniqueAddresses.length === 0) return '<div style="padding:10px;color:#999;">âš ï¸ æ­¤æ—¥æœŸç„¡æœ‰æ•ˆçš„åœ°å€è³‡æ–™</div>'; 

        // 2. å»ºç«‹åŒ…å«ã€Œèµ·é»ã€çš„åˆ—è¡¨
        const allPoints = [startPoint, ...uniqueAddresses];
        const listId = `route-list-${startInputId}`; // ç”¢ç”Ÿå”¯ä¸€ ID ä»¥å€åˆ†é€è²¨/æ–½å·¥

        // 3. ç”Ÿæˆ HTML
        let html = `<div id="${listId}" class="route-container">`;
        
        allPoints.forEach((addr, index) => {
            const isStart = index === 0;
            // æ‰¾å‡ºè©²åœ°å€å°æ‡‰çš„å®¢æˆ¶ (å¦‚æœæ˜¯èµ·é»å‰‡ç„¡)
            let relatedClients = [];
            if(!isStart) {
                const matchTasks = tasks.filter(t => t.address === addr);
                matchTasks.forEach(t => {
                   t.items.forEach(i => relatedClients.push(i.cust));
                });
            }
            const clientText = isStart ? '(å‡ºç™¼)' : ([...new Set(relatedClients)].join('/') || 'æœªçŸ¥å®¢æˆ¶');

            html += `
            <div class="route-card" draggable="true" data-addr="${addr}">
                <div class="route-icon-box">${isStart ? 'èµ·' : index}</div>
                <div class="route-info">
                    <div class="route-addr">${addr}</div>
                    <div class="route-desc">
                        <span>${isStart ? 'ğŸ¢' : 'ğŸ‘¤'} ${clientText}</span>
                        ${!isStart ? '<span style="color:#f59e0b">ğŸ“¦</span>' : ''}
                    </div>
                </div>
                <div class="route-actions">
                    <button class="btn-move" onclick="moveRouteItem('${listId}', this, -1)" title="ä¸Šç§»">â–²</button>
                    <button class="btn-move" onclick="moveRouteItem('${listId}', this, 1)" title="ä¸‹ç§»">â–¼</button>
                </div>
            </div>`;
        });
        html += `</div>`;

        // 4. ç¶å®šæ‹–æ›³äº‹ä»¶ (å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ DOM å·²å»ºç«‹)
        setTimeout(() => initDragAndDrop(listId), 100);

        return html;
    }

    // === æ–°å¢ï¼šåˆå§‹åŒ–æ‹–æ›³åŠŸèƒ½ ===
    function initDragAndDrop(listId) {
        const list = document.getElementById(listId);
        if(!list) return;

        let draggedItem = null;

        list.querySelectorAll('.route-card').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = item;
                setTimeout(() => item.classList.add('dragging'), 0);
            });

            item.addEventListener('dragend', function() {
                setTimeout(() => {
                    item.classList.remove('dragging');
                    draggedItem = null;
                    recalcRouteIndices(listId); // é‡æ–°è¨ˆç®—åºè™Ÿ
                }, 0);
            });
        });

        list.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(list, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                list.appendChild(draggable);
            } else {
                list.insertBefore(draggable, afterElement);
            }
        });
    }

    // è¼”åŠ©ï¼šè¨ˆç®—æ‹–æ›³ä½ç½®
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.route-card:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // === æ–°å¢ï¼šæŒ‰éˆ•ä¸Šä¸‹ç§»å‹•åŠŸèƒ½ ===
    function moveRouteItem(listId, btn, direction) {
        const item = btn.closest('.route-card');
        const list = document.getElementById(listId);
        if (direction === -1 && item.previousElementSibling) {
            list.insertBefore(item, item.previousElementSibling);
        } else if (direction === 1 && item.nextElementSibling) {
            list.insertBefore(item.nextElementSibling, item);
        }
        recalcRouteIndices(listId);
    }

    // === æ–°å¢ï¼šé‡æ–°è¨ˆç®—åºè™Ÿèˆ‡é¡è‰² ===
    function recalcRouteIndices(listId) {
        const list = document.getElementById(listId);
        const items = list.querySelectorAll('.route-card');
        items.forEach((item, index) => {
            const icon = item.querySelector('.route-icon-box');
            if(index === 0) {
                icon.innerText = 'èµ·';
                icon.style.background = '#10b981'; // ç¶ è‰²
            } else {
                icon.innerText = index;
                icon.style.background = (index === items.length - 1) ? '#ef4444' : '#3b82f6'; // æœ€å¾Œä¸€å€‹ç´…è‰²ï¼Œå…¶ä»–è—è‰²
            }
        });
    }

    // === ä¿®æ”¹ç‰ˆï¼šé–‹å•Ÿ Google Maps (è®€å–ç•«é¢ä¸Šæ’åºå¾Œçš„çµæœ) ===
    function openGoogleMapsRoute(viewMode) {
        let listId = '';
        
        if(viewMode === 'driver') {
            listId = 'route-list-routeStart';
        } else if (viewMode === 'installer') {
            listId = 'route-list-installRouteStart';
        }

        const listContainer = document.getElementById(listId);
        if(!listContainer) return alert('è«‹å…ˆç”¢ç”Ÿè·¯å¾‘åˆ—è¡¨');

        // å¾ DOM è®€å–ç›®å‰æ’å¥½çš„é †åº
        const cards = listContainer.querySelectorAll('.route-card');
        const addresses = Array.from(cards).map(card => card.getAttribute('data-addr'));

        if(addresses.length < 2) return alert('åœ°é»ä¸è¶³ï¼Œç„¡æ³•å°èˆª');

        // ç¬¬ä¸€å€‹æ˜¯èµ·é»
        const origin = encodeURIComponent(addresses[0]);
        // æœ€å¾Œä¸€å€‹æ˜¯çµ‚é»
        const destination = encodeURIComponent(addresses[addresses.length - 1]);
        
        let waypointsParam = '';
        // ä¸­é–“çš„æ˜¯åœé é»
        if(addresses.length > 2) {
            const midPoints = addresses.slice(1, addresses.length - 1);
            waypointsParam = `&waypoints=${midPoints.map(addr => encodeURIComponent(addr)).join('|')}`;
        }
        
        // èˆŠç‰ˆ Google Maps ç¶²å€åƒæ•¸
        // const mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypointsParam}&travelmode=driving`;
        
        // ä½¿ç”¨é€šç”¨æ ¼å¼ï¼Œé€šå¸¸ç›¸å®¹æ€§æ›´å¥½
      const mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypointsParam}&travelmode=driving`;
        
        window.open(mapUrl, '_blank');
    }
    
    // === Task Generation (With Print Button) ===
    function generateTaskHTML(tasks, gBy) { 
        if(tasks.length === 0) return '<div style="color:#999;padding:20px;font-size:14px;">ç„¡ä»»å‹™</div>'; 
        
        const g = {}; 
        tasks.forEach(t => { const k = t[gBy] || 'æœªæŒ‡å®š'; if(!g[k]) g[k] = []; g[k].push(t); }); 
        
        const hasSelection = selectedItems.length > 0;

        return Object.keys(g).map(k => `
            <div class="sub-task drop">
                <div class="task-header-text">${k}</div>
                ${g[k].map(t => {
                    const distinctCusts = [...new Set(t.items.map(i => i.cust))];
                    const custTitle = distinctCusts.join(' / ') || 'æœªæŒ‡å®šå®¢æˆ¶';
                    
                    const appendBtn = hasSelection 
                        ? `<button class="btn" style="width:100%; background:#8b5cf6; color:white; margin-bottom:10px; font-size:13px; box-shadow:0 2px 4px rgba(0,0,0,0.1);" onclick="appendSelectedToTask(${t.id})">â• å°‡é¸å–çš„ ${selectedItems.length} ç­†è¿½åŠ è‡³æ­¤å–®</button>` 
                        : '';
                    
                    // Add Print Button for Installer Mode
                    const printBtn = (t.mode === 'install') 
                        ? `<button class="btn" style="float:right; background:#4b5563; color:white; padding:4px 8px; font-size:12px; margin-left:10px;" onclick="openWorkOrder(${t.id})">ğŸ–¨ï¸ ç”¢ç”Ÿè©³ç´°å·¥å–®</button>` 
                        : '';

                    return `
                    <div class="task-card ${t.status==='done'?'task-card-done':''}" style="background:#f8fafc;padding:15px;border:2px solid #e2e8f0;border-radius:8px;margin-bottom:15px; position:relative;">
                        <div style="margin-bottom:5px;">
                            ${printBtn}
                            <div class="task-cust-title" style="display:inline-block;">${custTitle}</div>
                            <input type="date" value="${t.date}" onchange="updateTaskDate(${t.id}, this.value)" style="border:1px solid #ccc; font-size:12px; padding:2px; height:24px; vertical-align:middle; margin-left:5px;">
                        </div>

                        ${t.mode==='install'?`<div>ğŸ‘· ${t.worker} ${t.time?`(${t.time})`:''}</div>`:''}
                        ${t.factory?`<div>ğŸ  ${t.factory}</div>`:''}
                        ${t.address?`<div>ğŸ“ ${t.address}</div>`:''}
                        ${(t.contact||t.phone)?`<div style="font-size:13px; color:#4b5563;">ğŸ“ ${t.contact||''} ${t.phone||''}</div>`:''}
                        
                        ${appendBtn}

                        <div style="background:#fff7ed;color:#c2410c;padding:5px;margin-top:5px; border-radius:4px;">
                            <span style="cursor:pointer;" onclick="editTaskItemNote(${t.id})">ğŸ“ ${t.note || 'ç„¡å‚™è¨» (é»æ­¤æ–°å¢)'} <span style="font-size:10px; border:1px solid; padding:0 3px;">âœï¸</span></span>
                        </div>
                        
                        <div style="margin-top:10px;">
                            ${t.items.map(i=> {
                                const hasImg = !!i.img;
                                return `<div>â€¢ ${i.name} ${i.spec||''} 
                                    ${hasImg ? `<span class="img-icon" onclick="showImage('${i.uid}', '${i.img}')">ğŸ“·</span>` : ''}
                                    <button class="btn-revert" onclick="returnToPool(${t.id},'${i.uid}')">â†©ï¸</button>
                                </div>`;
                            }).join('')}
                        </div>

                        <div style="margin-top:15px; border-top:1px dashed #ddd; padding-top:10px; text-align:right;">
                            ${t.status !== 'done' ? 
                                `<button class="btn btn-success" style="padding:5px 15px; font-size:13px;" onclick="completeTask(${t.id})">âœ… å®Œæˆä»»å‹™</button>` : 
                                `<div style="display:flex; justify-content:flex-end; align-items:center; gap:10px;">
                                    <span style="color:green; font-weight:bold;">å·²å®Œæˆ</span>
                                    <button class="btn" style="background:#cbd5e1; font-size:12px; padding:4px 8px;" onclick="undoCompleteTask(${t.id})">â†©ï¸ å¾©åŸ</button>
                                 </div>`
                            }
                        </div>
                    </div>
                `}).join('')}
            </div>`).join(''); 
    }

    function updateTaskDate(tid, newDate) {
        if(!newDate) return;
        const idx = db.logistics.findIndex(t => t.id === tid);
        if(idx !== -1) {
            db.logistics[idx].date = newDate;
            pushToCloud();
            renderViews();
            updateDashboard();
        }
    }

    function completeTask(tid) {
        const t = db.logistics.find(x => x.id === tid);
        if(t) { t.status = 'done'; pushToCloud(); renderViews(); updateDashboard(); }
    }

    function undoCompleteTask(tid) {
        const t = db.logistics.find(x => x.id === tid);
        if(t) { t.status = 'pending'; pushToCloud(); renderViews(); updateDashboard(); }
    }

    function appendSelectedToTask(tid) {
        if(selectedItems.length === 0) return alert('è«‹å…ˆå›åˆ° [KEYå–®è€…] é é¢é¸å–è¦è¿½åŠ çš„é …ç›®ï¼');
        
        const task = db.logistics.find(t => t.id === tid);
        if(!task) return;

        if(!confirm(`ç¢ºå®šè¦å°‡é¸å–çš„ ${selectedItems.length} ç­†è¨‚å–®è¿½åŠ åˆ°\nã€Œ${task.address || task.factory || 'æ­¤ä»»å‹™'}ã€å—ï¼Ÿ`)) return;

        task.items.push(...selectedItems);
        selectedItems = [];
        if(document.getElementById('selectedItemsSummary')) {
            document.getElementById('selectedItemsSummary').innerText = '';
        }
        pushToCloud();
        renderViews();
        alert('âœ… è¿½åŠ æˆåŠŸï¼');
    }

function openGoogleMapsRoute(viewMode) {
        let dateInputId = '';
        let startInputId = ''; 
        let modeFilter = '';

        if(viewMode === 'driver') {
            dateInputId = 'driverDate';
            startInputId = 'routeStart';
            modeFilter = 'self';
        } else if (viewMode === 'installer') {
            dateInputId = 'installDate';
            startInputId = 'installRouteStart';
            modeFilter = 'install';
        }

        if(!dateInputId) return;

        const dateVal = document.getElementById(dateInputId).value;
        if(!dateVal) return alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');

        let tasks = db.logistics.filter(t => t.date === dateVal && t.mode === modeFilter && t.address && t.address.trim() !== '');
        tasks = sortTasksByAddress(tasks);

        if(tasks.length === 0) {
            alert('è©²æ—¥æœŸç„¡æœ‰æ•ˆçš„åœ°å€');
            return;
        }

        // å–å¾—ç›®å‰ç•«é¢ä¸Šçš„æ’åº (æ”¯æ´æ‰‹å‹•æ‹–æ›³å¾Œçš„é †åº)
        // æ³¨æ„ï¼šé€™è£¡éœ€è¦è®€å– DOM ä¸Šçš„é †åºï¼Œè€Œä¸æ˜¯ db çš„åŸå§‹é †åºï¼Œæ‰èƒ½åæ‡‰æ‰‹å‹•èª¿æ•´çš„çµæœ
        let listId = (viewMode === 'driver') ? 'route-list-routeStart' : 'route-list-installRouteStart';
        const listContainer = document.getElementById(listId);
        
        let addresses = [];
        if (listContainer) {
            // å¦‚æœç•«é¢ä¸Šæœ‰åˆ—è¡¨ï¼Œä¾ç…§ç•«é¢é †åºæŠ“å–åœ°å€
            const cards = listContainer.querySelectorAll('.route-card');
            addresses = Array.from(cards).map(card => card.getAttribute('data-addr'));
        } else {
            // å¦‚æœé‚„æ²’ç”Ÿæˆåˆ—è¡¨ï¼Œå‰‡ä½¿ç”¨é è¨­æ’åº
            addresses = [...new Set(tasks.map(t => t.address.trim()))];
        }

        if(addresses.length === 0) return;

        const startPointInput = document.getElementById(startInputId);
        const startPoint = (startPointInput ? startPointInput.value.trim() : 'ç¸½å…¬å¸') || 'ç¸½å…¬å¸';
        
        // ä¿®æ­£å¾Œçš„è®Šæ•¸ç·¨ç¢¼èˆ‡ç¶²å€æ ¼å¼
        const origin = encodeURIComponent(startPoint);
        const destination = encodeURIComponent(addresses[addresses.length - 1]);
        
        let waypointsParam = '';
        if(addresses.length > 1) {
            // å–ä¸­é–“é»ä½œç‚ºé€”ç¶“é»
            const midPoints = addresses.slice(0, addresses.length - 1);
            waypointsParam = `&waypoints=${midPoints.map(addr => encodeURIComponent(addr)).join('|')}`;
        }

        // ä½¿ç”¨æ­£ç¢ºçš„ Google Maps Universal Cross-Platform URL
const mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypointsParam}&travelmode=driving`;
        
        window.open(mapUrl, '_blank');
    }

    function openConfig() {
        document.getElementById('configModal').style.display = 'flex';
        document.getElementById('api_url_input').value = API_URL.includes('script.google') ? API_URL : '';
    }

    function saveConfig() {
        const url = document.getElementById('api_url_input').value.trim();
        if (!url) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Google Script ç¶²å€ï¼");
            return;
        }
        API_URL = url;
        localStorage.setItem('erp_api_url', url); 
        document.getElementById('configModal').style.display = 'none';
        syncCloud(); 
    }

    // === æ–°å¢/ç§»å‹•ï¼šå‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ ===
    function openDataModal() {
        document.getElementById('dataModal').style.display = 'flex';
    }

    function backupData() {
        // å»ºç«‹è³‡æ–™å‚™ä»½æª”
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Logistics_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function triggerRestore() {
        if(!confirm("âš ï¸ è­¦å‘Šï¼šé‚„åŸè³‡æ–™å°‡æœƒè¦†è“‹ç›®å‰æ‰€æœ‰å°šæœªåŒæ­¥çš„è³‡æ–™ã€‚\nè«‹ç¢ºèªæ‚¨è¦åŸ·è¡Œæ­¤æ“ä½œï¼")) return;
        document.getElementById('restoreFile').click();
    }

    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedDb = JSON.parse(e.target.result);
                
                // ç°¡å–®é©—è­‰è³‡æ–™çµæ§‹
                if(loadedDb.logistics && Array.isArray(loadedDb.logistics) && Array.isArray(loadedDb.manualOrders)) {
                    db = loadedDb;
                    // åŒæ­¥åˆ°é›²ç«¯ï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´
                    pushToCloud(); 
                    
                    renderPool();
                    renderViews();
                    updateDashboard();
                    alert("âœ… è³‡æ–™é‚„åŸæˆåŠŸï¼å·²åŒæ­¥è‡³é›²ç«¯ã€‚");
                    document.getElementById('dataModal').style.display = 'none';
                } else {
                    alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šé€™ä¼¼ä¹ä¸æ˜¯æœ¬ç³»çµ±çš„å‚™ä»½æª”ã€‚");
                }
            } catch(err) {
                alert("âŒ é‚„åŸå¤±æ•—ï¼š" + err);
            }
        };
        reader.readAsText(file);
        input.value = ''; // é‡ç½® input ä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸åŒå€‹æª”æ¡ˆ
    }
// === åœ°åœ–æ•´åˆæ ¸å¿ƒé‚è¼¯ (Leaflet + OpenStreetMap) ===
    let maps = { driver: null, install: null };
    let markers = { driver: [], install: [] };
    let polylines = { driver: null, install: null };
    let addrCache = {}; // åœ°å€åº§æ¨™å¿«å–ï¼Œé¿å…é‡è¤‡æŸ¥è©¢

    // 1. åˆå§‹åŒ–åœ°åœ–
function initMap(type) {
        const mapId = type === 'driver' ? 'map-driver' : 'map-install';
        if (maps[type]) return; 

        maps[type] = L.map(mapId).setView([25.0330, 121.5654], 12);
        
        // ä½¿ç”¨ CartoDB Voyager (No Labels) - æ¥µç°¡é¢¨æ ¼ï¼Œå¹¾ä¹åªæœ‰è¼ªå»“
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(maps[type]);
    }
    // 2. åœ°å€è½‰åº§æ¨™ (ä½¿ç”¨ Nominatim å…è²» API)
    async function getCoordinates(address) {
        if (!address) return null;
        address = address.trim();
        if (address === 'ç¸½å…¬å¸' || address === 'å…¬å¸') address = 'å°åŒ—å¸‚'; // è«‹è‡ªè¡Œä¿®æ”¹ç‚ºè²´å…¬å¸çœŸå¯¦åœ°å€

        if (addrCache[address]) return addrCache[address]; // è®€å–å¿«å–

        try {
            // å»¶é² 1 ç§’é¿å…è«‹æ±‚éå¿«è¢«å°é–
            await new Promise(r => setTimeout(r, 800)); 
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data && data.length > 0) {
                const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                addrCache[address] = coords;
                return coords;
            }
        } catch (e) {
            console.error("Geocoding error:", e);
        }
        return null;
    }

    // 3. ç¹ªè£½è·¯å¾‘åœ–
async function drawMapRoute(listId, type) {
        const listContainer = document.getElementById(listId);
        if(!listContainer) return;

        const loadingDiv = document.getElementById(type === 'driver' ? 'loading-driver' : 'loading-install');
        loadingDiv.style.display = 'flex';

        // ç¢ºä¿åœ°åœ–å·²åˆå§‹åŒ–
        setTimeout(() => {
             initMap(type);
             maps[type].invalidateSize(); 
        }, 100);

        const cards = listContainer.querySelectorAll('.route-card');
        const addresses = Array.from(cards).map(card => card.getAttribute('data-addr'));
        
        // æ¸…é™¤èˆŠæ¨™è¨˜èˆ‡ç·šæ¢
        if (polylines[type]) maps[type].removeLayer(polylines[type]);
        markers[type].forEach(m => maps[type].removeLayer(m));
        markers[type] = [];

        const latLngs = [];
        const bounds = [];

        for (let i = 0; i < addresses.length; i++) {
            const addr = addresses[i];
            const coords = await getCoordinates(addr);
            
            if (coords) {
                latLngs.push(coords);
                bounds.push(coords);

                // è¨­å®šæ¨£å¼ Class
                let cssClass = 'map-marker-icon';
                if (i === 0) cssClass += ' marker-start';
                else if (i === addresses.length - 1) cssClass += ' marker-end';

                // â˜…â˜…â˜… ä¿®æ­£é‡é»ï¼šæ¨£å¼ç›´æ¥å¥—ç”¨åœ¨ classNameï¼Œhtml åªæ”¾æ•¸å­— â˜…â˜…â˜…
                const icon = L.divIcon({
                    className: cssClass,
                    html: i === 0 ? 'èµ·' : i, 
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker(coords, { icon: icon }).addTo(maps[type]);
                marker.bindPopup(`<b>${i===0?'èµ·é»':`ç«™é» ${i}`}</b><br>${addr}`);
                markers[type].push(marker);
            }
        }
                                  
        if (latLngs.length > 1) {
            polylines[type] = L.polyline(latLngs, { color: '#3b82f6', weight: 4, opacity: 0.7, dashArray: '5, 10' }).addTo(maps[type]);
            maps[type].fitBounds(bounds, { padding: [50, 50] });
        }

        loadingDiv.style.display = 'none';
    }

    // === ä¿®æ”¹å¾Œçš„æ¸²æŸ“è§¸ç™¼ (æ•´åˆåœ°åœ–) ===
    // è«‹æ‰¾åˆ°åŸæœ¬çš„ renderDriverView ä¸¦åœ¨æœ€å¾ŒåŠ å…¥ drawMapRoute
    const originalRenderDriverView = renderDriverView;
    renderDriverView = function() {
        // åŸ·è¡ŒåŸæœ¬çš„é‚è¼¯
        const d = document.getElementById('driverDate').value; 
        let tasks = db.logistics.filter(x => x.mode==='self' && x.date===d); 
        tasks = sortTasksByAddress(tasks);
        
        document.getElementById('driverPickupContent').innerHTML = generatePickupSummary(tasks, 'self');
        document.getElementById('driverRouteTimeline').innerHTML = generateRoutePlanner(tasks, 'routeStart');
        document.getElementById('driverContent').innerHTML = generateTaskHTML(tasks, 'address');
        
        // â˜…â˜…â˜… æ–°å¢ï¼šè§¸ç™¼åœ°åœ–ç¹ªè£½ â˜…â˜…â˜…
        drawMapRoute('route-list-routeStart', 'driver');
    };

    const originalRenderInstallView = renderInstallView;
    renderInstallView = function() {
        const d = document.getElementById('installDate').value; 
        let tasks = db.logistics.filter(x => x.mode === 'install' && x.date === d); 
        tasks = sortTasksByAddress(tasks);

        document.getElementById('installPickupContent').innerHTML = generatePickupSummary(tasks, 'install');
        document.getElementById('installRouteTimeline').innerHTML = generateRoutePlanner(tasks, 'installRouteStart');
        document.getElementById('installContent').innerHTML = generateTaskHTML(tasks, 'worker'); 
        
        // â˜…â˜…â˜… æ–°å¢ï¼šè§¸ç™¼åœ°åœ–ç¹ªè£½ â˜…â˜…â˜…
        drawMapRoute('route-list-installRouteStart', 'install');
    };

    // === ä¿®æ”¹ï¼šæ‹–æ›³çµæŸå¾Œï¼Œè‡ªå‹•æ›´æ–°åœ°åœ– ===
    // æ‰¾åˆ°åŸæœ¬çš„ initDragAndDrop å‡½å¼ï¼Œåœ¨ dragend äº‹ä»¶ä¸­åŠ å…¥é‡ç¹ª
    const originalInitDragAndDrop = initDragAndDrop;
    initDragAndDrop = function(listId) {
        const list = document.getElementById(listId);
        if(!list) return;
        let draggedItem = null;

        list.querySelectorAll('.route-card').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = item;
                setTimeout(() => item.classList.add('dragging'), 0);
            });

            item.addEventListener('dragend', function() {
                setTimeout(() => {
                    item.classList.remove('dragging');
                    draggedItem = null;
                    recalcRouteIndices(listId);
                    
                    // â˜…â˜…â˜… æ–°å¢ï¼šæ‹–æ›³æ”¾é–‹å¾Œï¼Œé‡ç•«åœ°åœ–é€£ç·š â˜…â˜…â˜…
                    const type = listId.includes('install') ? 'install' : 'driver';
                    drawMapRoute(listId, type);
                    
                }, 0);
            });
        });

        // åŠ ä¸ŠæŒ‰éˆ•ç§»å‹•çš„ç›£è½ (è‹¥æ‚¨æœ‰ä½¿ç”¨ä¸Šç§»/ä¸‹ç§»æŒ‰éˆ•)
        window.updateMapAfterMove = function(listId) {
             const type = listId.includes('install') ? 'install' : 'driver';
             drawMapRoute(listId, type);
        }

        list.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(list, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) { list.appendChild(draggable); } 
            else { list.insertBefore(draggable, afterElement); }
        });
    }

    // ä¿®æ”¹æŒ‰éˆ•ç§»å‹•å‡½å¼ï¼ŒåŠ å…¥å›èª¿
    const originalMoveRouteItem = moveRouteItem;
    moveRouteItem = function(listId, btn, direction) {
        originalMoveRouteItem(listId, btn, direction); // åŸ·è¡ŒåŸæœ¬ç§»å‹•
        window.updateMapAfterMove(listId); // è§¸ç™¼é‡ç¹ª
    }
// === åœ°åœ–ç›´æ¥èª¿æ•´é †åºåŠŸèƒ½ ===
    function adjustOrderOnMap(listId, currentIndex, direction) {
        const list = document.getElementById(listId);
        if(!list) return;

        // å–å¾—æ‰€æœ‰å¡ç‰‡
        const cards = Array.from(list.querySelectorAll('.route-card'));
        const targetCard = cards[currentIndex];
        
        // äº¤æ›ä½ç½®
        if (direction === -1 && targetCard.previousElementSibling) {
            // å¾€å‰ (ä¸Šç§»)
            list.insertBefore(targetCard, targetCard.previousElementSibling);
        } else if (direction === 1 && targetCard.nextElementSibling) {
            // å¾€å¾Œ (ä¸‹ç§»)
            list.insertBefore(targetCard.nextElementSibling, targetCard);
        }

        // é‡æ–°è¨ˆç®—åºè™Ÿèˆ‡é‡ç¹ªåœ°åœ–
        recalcRouteIndices(listId);
        
        // åˆ¤æ–·æ˜¯å“ªä¸€ç¨®åœ°åœ– (driver æˆ– install)
        const type = listId.includes('install') ? 'install' : 'driver';
        
        // ç¨å¾®å»¶é²ä¸€ä¸‹è®“ DOM æ›´æ–°
        setTimeout(() => {
            drawMapRoute(listId, type);
        }, 100);
    }

</script>
</body>
</html>